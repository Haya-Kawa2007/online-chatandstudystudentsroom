<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyHome - ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å­¦ç¿’ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: white;
            transition: background 0.3s ease;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .achievement-badge {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 5px;
            position: relative;
            cursor: pointer;
        }
        .user-frame {
            border: 3px solid;
            border-radius: 50%;
        }
        .frame-blue { border-color: #3b82f6; }
        .frame-green { border-color: #10b981; }
        .frame-red { border-color: #ef4444; }
        .frame-silver { border-color: #6b7280; }
        .frame-gold { border-color: #f59e0b; }
        .frame-diamond { 
            border: 3px solid;
            background: linear-gradient(45deg, #a855f7, #3b82f6, #10b981, #f59e0b);
            background-size: 400% 400%;
            animation: rainbow 3s ease infinite;
        }
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .notification-dot {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: #ef4444;
            border-radius: 50%;
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .timer-display {
            font-size: 3rem;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }
        .word-card {
            perspective: 1000px;
            height: 200px;
        }
        .word-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .word-card.flipped .word-card-inner {
            transform: rotateY(180deg);
        }
        .word-card-front, .word-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .word-card-back {
            transform: rotateY(180deg);
            background: #f3f4f6;
        }
    </style>
</head>
<body class="min-h-screen bg-white">
    <!-- Access Password Screen -->
    <div id="accessScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
        <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
            <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">StudyHome</h1>
            <p class="text-gray-600 text-center mb-6">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å­¦ç¿’ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã¸ã‚ˆã†ã“ã</p>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">ã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="accessPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
            </div>
            <button onclick="checkAccess()" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition-colors">
                ã‚¢ã‚¯ã‚»ã‚¹
            </button>
            <div id="accessError" class="text-red-500 text-sm mt-2 hidden">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“</div>
        </div>
    </div>

    <!-- Login/Register Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 hidden">
        <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
            <h2 class="text-2xl font-bold text-center mb-6">ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ²</h2>
            
            <!-- Login Form -->
            <div id="loginForm">
                <h3 class="text-lg font-semibold mb-4">ãƒ­ã‚°ã‚¤ãƒ³</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">åå‰</label>
                    <input type="text" id="loginName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
                    <input type="text" id="loginId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button onclick="login()" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition-colors mb-4">
                    ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <h3 class="text-lg font-semibold mb-4">æ–°è¦ç™»éŒ²</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">åå‰</label>
                    <input type="text" id="registerName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
                    <input type="text" id="registerId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button onclick="register()" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700 transition-colors mb-4">
                    æ–°è¦ç™»éŒ²
                </button>
            </div>
            
            <div class="text-center">
                <button onclick="toggleForm()" id="toggleButton" class="text-blue-600 hover:text-blue-800 underline">
                    æ–°è¦ç™»éŒ²ã¯ã“ã¡ã‚‰
                </button>
            </div>
            <div id="loginError" class="text-red-500 text-sm mt-2 hidden"></div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white shadow-sm p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">StudyHome</h1>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-star text-yellow-500"></i>
                    <span id="userPoints">0</span>
                    <span class="text-sm text-gray-500">ãƒã‚¤ãƒ³ãƒˆ</span>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-trophy text-blue-500"></i>
                    <span id="userExp">0</span>
                    <span class="text-sm text-gray-500">EXP</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-500">Lv.</span>
                    <span id="userLevel">1</span>
                </div>
                <div id="userProfileHeader" class="flex items-center space-x-2">
                    <div class="w-8 h-8 rounded-full bg-gray-300 user-frame frame-blue flex items-center justify-center">
                        <i class="fas fa-user text-gray-600"></i>
                    </div>
                    <span id="headerUserName">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 pb-20">
            <!-- Posts Tab -->
            <div id="postsTab" class="tab-content active p-4">
                <div class="max-w-4xl mx-auto">
                    <div class="mb-6">
                        <div class="bg-white rounded-lg shadow p-4 mb-4">
                            <h3 class="font-semibold mb-3">æ–°ã—ã„æŠ•ç¨¿ãƒ»è³ªå•</h3>
                            <textarea id="postContent" class="w-full p-3 border border-gray-300 rounded-md resize-none" rows="3" placeholder="è³ªå•ã‚„è§£èª¬ã‚’æŠ•ç¨¿ã—ã¦ãã ã•ã„..."></textarea>
                            <div class="flex justify-between items-center mt-3">
                                <div class="flex space-x-2">
                                    <input type="file" id="postFile" accept="image/*,.pdf" class="hidden">
                                    <button onclick="document.getElementById('postFile').click()" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                                        <i class="fas fa-paperclip mr-1"></i>ãƒ•ã‚¡ã‚¤ãƒ«
                                    </button>
                                    <select id="postSubject" class="px-3 py-1 border border-gray-300 rounded">
                                        <option value="general">ä¸€èˆ¬</option>
                                        <option value="math">æ•°å­¦</option>
                                        <option value="english">è‹±èª</option>
                                        <option value="science">ç†ç§‘</option>
                                        <option value="social">ç¤¾ä¼š</option>
                                        <option value="japanese">å›½èª</option>
                                    </select>
                                </div>
                                <button onclick="createPost()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    æŠ•ç¨¿
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="postsList" class="space-y-4">
                        <!-- Posts will be dynamically added here -->
                    </div>
                </div>
            </div>

            <!-- Timer Tab -->
            <div id="timerTab" class="tab-content p-4">
                <div class="max-w-2xl mx-auto">
                    <div class="bg-white rounded-lg shadow p-6 text-center mb-6">
                        <h3 class="text-xl font-semibold mb-6">å‹‰å¼·ã‚¿ã‚¤ãƒãƒ¼</h3>
                        
                        <div class="mb-6">
                            <div class="timer-display text-6xl mb-4" id="timerDisplay">25:00</div>
                            <div class="flex justify-center space-x-4 mb-4">
                                <button onclick="startTimer()" id="startBtn" class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                                    <i class="fas fa-play mr-2"></i>é–‹å§‹
                                </button>
                                <button onclick="pauseTimer()" id="pauseBtn" class="px-6 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">
                                    <i class="fas fa-pause mr-2"></i>ä¸€æ™‚åœæ­¢
                                </button>
                                <button onclick="resetTimer()" id="resetBtn" class="px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                                    <i class="fas fa-stop mr-2"></i>ãƒªã‚»ãƒƒãƒˆ
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">å‹‰å¼·æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
                                <input type="number" id="studyTime" value="25" min="1" max="120" class="w-full px-3 py-2 border border-gray-300 rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">ä¼‘æ†©æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
                                <input type="number" id="breakTime" value="5" min="1" max="30" class="w-full px-3 py-2 border border-gray-300 rounded">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">ç§‘ç›®</label>
                            <select id="timerSubject" class="w-full px-3 py-2 border border-gray-300 rounded">
                                <option value="math">æ•°å­¦</option>
                                <option value="english">è‹±èª</option>
                                <option value="science">ç†ç§‘</option>
                                <option value="social">ç¤¾ä¼š</option>
                                <option value="japanese">å›½èª</option>
                            </select>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">æ‰‹å‹•ã§å‹‰å¼·æ™‚é–“ã‚’è¨˜éŒ²</h3>
                        <div class="grid grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">ç§‘ç›®</label>
                                <select id="manualSubject" class="w-full px-3 py-2 border border-gray-300 rounded">
                                    <option value="math">æ•°å­¦</option>
                                    <option value="english">è‹±èª</option>
                                    <option value="science">ç†ç§‘</option>
                                    <option value="social">ç¤¾ä¼š</option>
                                    <option value="japanese">å›½èª</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
                                <input type="number" id="manualTime" min="1" max="600" class="w-full px-3 py-2 border border-gray-300 rounded">
                            </div>
                            <div class="flex items-end">
                                <button onclick="addManualStudyTime()" class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    è¨˜éŒ²
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6 mt-6">
                        <h3 class="text-lg font-semibold mb-4">å‹‰å¼·æ™‚é–“çµ±è¨ˆ</h3>
                        <div class="mb-4">
                            <select id="chartPeriod" onchange="updateStudyChart()" class="px-3 py-2 border border-gray-300 rounded">
                                <option value="week">é€±é–“</option>
                                <option value="month">æœˆé–“</option>
                            </select>
                        </div>
                        <canvas id="studyChart" style="height: 300px;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Chat Tab -->
            <div id="chatTab" class="tab-content p-4">
                <div class="max-w-4xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 h-96">
                        <!-- Chat List -->
                        <div class="md:col-span-1 bg-white rounded-lg shadow p-4">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-semibold">ãƒãƒ£ãƒƒãƒˆ</h3>
                                <button onclick="showGroupCreate()" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div id="chatList" class="space-y-2">
                                <!-- Chat rooms will be listed here -->
                            </div>
                            
                            <div class="mt-4">
                                <h4 class="font-medium mb-2">å€‹äººãƒãƒ£ãƒƒãƒˆ</h4>
                                <select id="privateChatSelect" onchange="openPrivateChat()" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                    <option value="">ç›¸æ‰‹ã‚’é¸æŠ</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Chat Area -->
                        <div class="md:col-span-3 bg-white rounded-lg shadow flex flex-col">
                            <div id="chatHeader" class="p-4 border-b bg-gray-50 rounded-t-lg">
                                <h4 class="font-semibold">ãƒãƒ£ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</h4>
                            </div>
                            <div id="chatMessages" class="flex-1 p-4 overflow-y-auto">
                                <!-- Messages will appear here -->
                            </div>
                            <div id="chatInput" class="p-4 border-t hidden">
                                <div class="flex space-x-2">
                                    <input type="text" id="messageInput" class="flex-1 px-3 py-2 border border-gray-300 rounded-md" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
                                    <button onclick="sendMessage()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                        é€ä¿¡
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Group Creation Modal -->
                <div id="groupCreateModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                    <div class="bg-white rounded-lg p-6 w-96">
                        <h3 class="text-lg font-semibold mb-4">ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆä½œæˆ</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">ã‚°ãƒ«ãƒ¼ãƒ—å</label>
                            <input type="text" id="groupName" class="w-full px-3 py-2 border border-gray-300 rounded">
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠ</label>
                            <div id="groupMemberSelect" class="max-h-32 overflow-y-auto border border-gray-300 rounded p-2">
                                <!-- User checkboxes will be added here -->
                            </div>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button onclick="closeGroupCreate()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                            <button onclick="createGroup()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                ä½œæˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profileTab" class="tab-content p-4">
                <div class="max-w-2xl mx-auto">
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <h3 class="text-xl font-semibold mb-6 text-center">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
                        
                        <div class="text-center mb-6">
                            <div class="w-24 h-24 rounded-full bg-gray-300 mx-auto mb-4 user-frame frame-blue flex items-center justify-center cursor-pointer" onclick="changeProfileImage()">
                                <i class="fas fa-user text-gray-600 text-2xl" id="profileIcon"></i>
                            </div>
                            <input type="file" id="profileImageInput" accept="image/*" class="hidden">
                            <h4 class="text-lg font-semibold" id="profileName">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</h4>
                            <p class="text-gray-600">Level <span id="profileLevel">1</span></p>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">åå‰</label>
                                <input type="text" id="editName" class="w-full px-3 py-2 border border-gray-300 rounded">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">ãƒã‚¤ãƒ³ãƒˆ</label>
                                    <div class="px-3 py-2 bg-gray-100 rounded text-gray-600" id="profilePoints">0</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">çµŒé¨“å€¤</label>
                                    <div class="px-3 py-2 bg-gray-100 rounded text-gray-600" id="profileExp">0</div>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2">ç·å‹‰å¼·æ™‚é–“</label>
                                <div class="px-3 py-2 bg-gray-100 rounded text-gray-600" id="totalStudyTime">0åˆ†</div>
                            </div>

                            <button onclick="saveProfile()" class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                ä¿å­˜
                            </button>
                        </div>
                    </div>

                    <!-- Achievements -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆ</h3>
                        <div id="achievementsList" class="grid grid-cols-4 gap-4">
                            <!-- Achievement badges will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content p-4">
                <div class="max-w-2xl mx-auto space-y-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">é€šçŸ¥è¨­å®š</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <label class="text-sm font-medium">30åˆ†ã”ã¨ã®é€šçŸ¥</label>
                                <input type="checkbox" id="notificationEnabled" class="rounded">
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="text-sm font-medium">é™ã‹ãƒ¢ãƒ¼ãƒ‰</label>
                                <input type="checkbox" id="quietMode" class="rounded">
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="text-sm font-medium">ã‚¿ã‚¤ãƒãƒ¼å®Œäº†é€šçŸ¥</label>
                                <input type="checkbox" id="timerNotification" class="rounded">
                            </div>
                            <div class="flex justify-between items-center">
                                <label class="text-sm font-medium">ãƒãƒ£ãƒƒãƒˆé€šçŸ¥</label>
                                <input type="checkbox" id="chatNotification" class="rounded">
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">èƒŒæ™¯è¨­å®š</h3>
                        <div class="grid grid-cols-4 gap-3 mb-4">
                            <div onclick="changeBackground('white')" class="w-full h-16 bg-white border-2 border-gray-300 rounded cursor-pointer"></div>
                            <div onclick="changeBackground('#f3f4f6')" class="w-full h-16 bg-gray-100 border-2 border-gray-300 rounded cursor-pointer"></div>
                            <div onclick="changeBackground('#dbeafe')" class="w-full h-16 bg-blue-100 border-2 border-gray-300 rounded cursor-pointer"></div>
                            <div onclick="changeBackground('#dcfce7')" class="w-full h-16 bg-green-100 border-2 border-gray-300 rounded cursor-pointer"></div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">ã‚«ã‚¹ã‚¿ãƒ èƒŒæ™¯ç”»åƒ</label>
                            <input type="file" id="backgroundImage" accept="image/*" class="w-full px-3 py-2 border border-gray-300 rounded">
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">ãƒã‚¤ãƒ³ãƒˆã‚·ãƒ§ãƒƒãƒ—</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center p-3 border rounded">
                                <div>
                                    <div class="font-medium">çµŒé¨“å€¤1.1å€ãƒ–ãƒ¼ã‚¹ãƒˆ</div>
                                    <div class="text-sm text-gray-500">æ¬¡å›è³¼å…¥: <span id="expBoostPrice">100</span>ãƒã‚¤ãƒ³ãƒˆ</div>
                                </div>
                                <button onclick="buyExpBoost()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    è³¼å…¥
                                </button>
                            </div>
                            <div class="flex justify-between items-center p-3 border rounded">
                                <div>
                                    <div class="font-medium">ãƒã‚¤ãƒ³ãƒˆ&çµŒé¨“å€¤1.2å€ãƒ–ãƒ¼ã‚¹ãƒˆ</div>
                                    <div class="text-sm text-gray-500">æ¬¡å›è³¼å…¥: <span id="doubleBoostPrice">200</span>ãƒã‚¤ãƒ³ãƒˆ</div>
                                </div>
                                <button onclick="buyDoubleBoost()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                                    è³¼å…¥
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">ç®¡ç†è€…ãƒ»é–¢ä¿‚è€…</h3>
                        <div class="space-y-3">
                            <button onclick="showAdminLogin()" class="w-full px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">
                                ç®¡ç†ç”»é¢ã¸
                            </button>
                            <button onclick="logout()" class="w-full px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Word Cards Tab -->
            <div id="wordCardsTab" class="tab-content p-4">
                <div class="max-w-4xl mx-auto">
                    <div class="mb-6 flex justify-between items-center">
                        <h3 class="text-xl font-semibold">å˜èªã‚«ãƒ¼ãƒ‰</h3>
                        <button onclick="showCreateCardSet()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            <i class="fas fa-plus mr-2"></i>æ–°ã—ã„ã‚»ãƒƒãƒˆä½œæˆ
                        </button>
                    </div>

                    <!-- Card Sets List -->
                    <div id="cardSetsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        <!-- Card sets will be displayed here -->
                    </div>

                    <!-- Card Study Area -->
                    <div id="cardStudyArea" class="hidden">
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-lg font-semibold" id="currentCardSetName">ã‚«ãƒ¼ãƒ‰ã‚»ãƒƒãƒˆå</h4>
                                <button onclick="exitCardStudy()" class="text-gray-600 hover:text-gray-800">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="text-center mb-4">
                                <span id="cardProgress">1 / 10</span>
                            </div>
                            <div class="word-card mx-auto max-w-md cursor-pointer" onclick="flipCard()">
                                <div class="word-card-inner">
                                    <div class="word-card-front">
                                        <div id="cardFront">å˜èª</div>
                                    </div>
                                    <div class="word-card-back">
                                        <div id="cardBack">æ„å‘³</div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-center space-x-4 mt-6">
                                <button onclick="previousCard()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                                    <i class="fas fa-chevron-left mr-2"></i>å‰ã¸
                                </button>
                                <button onclick="nextCard()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    æ¬¡ã¸<i class="fas fa-chevron-right ml-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Create Card Set Modal -->
                <div id="createCardSetModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                    <div class="bg-white rounded-lg p-6 w-96 max-h-96 overflow-y-auto">
                        <h3 class="text-lg font-semibold mb-4">å˜èªã‚«ãƒ¼ãƒ‰ã‚»ãƒƒãƒˆä½œæˆ</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">ã‚»ãƒƒãƒˆå</label>
                            <input type="text" id="cardSetName" class="w-full px-3 py-2 border border-gray-300 rounded" placeholder="ä¾‹: è‹±æ¤œç”¨1">
                        </div>
                        <div class="mb-4">
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium">ã‚«ãƒ¼ãƒ‰</label>
                                <button onclick="addCardInput()" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div id="cardInputs" class="space-y-2">
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" class="px-2 py-1 border border-gray-300 rounded text-sm" placeholder="å˜èªãƒ»å•é¡Œ">
                                    <input type="text" class="px-2 py-1 border border-gray-300 rounded text-sm" placeholder="æ„å‘³ãƒ»ç­”ãˆ">
                                </div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <div class="flex justify-between items-center">
                                <label class="text-sm font-medium">å…¬é–‹è¨­å®š</label>
                                <input type="checkbox" id="cardSetPublic" class="rounded">
                            </div>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button onclick="closeCreateCardSet()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                            <button onclick="createCardSet()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                ä½œæˆ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t">
            <div class="flex justify-around py-2">
                <button onclick="switchTab('posts')" class="tab-btn flex flex-col items-center p-2 text-blue-600">
                    <i class="fas fa-edit text-xl"></i>
                    <span class="text-xs mt-1">æŠ•ç¨¿ãƒ»è³ªå•</span>
                </button>
                <button onclick="switchTab('timer')" class="tab-btn flex flex-col items-center p-2 text-gray-600">
                    <i class="fas fa-clock text-xl"></i>
                    <span class="text-xs mt-1">ã‚¿ã‚¤ãƒãƒ¼</span>
                </button>
                <button onclick="switchTab('chat')" class="tab-btn flex flex-col items-center p-2 text-gray-600">
                    <div class="relative">
                        <i class="fas fa-comments text-xl"></i>
                        <div id="chatNotificationBadge" class="notification-dot hidden">!</div>
                    </div>
                    <span class="text-xs mt-1">ãƒãƒ£ãƒƒãƒˆ</span>
                </button>
                <button onclick="switchTab('profile')" class="tab-btn flex flex-col items-center p-2 text-gray-600">
                    <i class="fas fa-user text-xl"></i>
                    <span class="text-xs mt-1">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</span>
                </button>
                <button onclick="switchTab('settings')" class="tab-btn flex flex-col items-center p-2 text-gray-600">
                    <i class="fas fa-cog text-xl"></i>
                    <span class="text-xs mt-1">è¨­å®š</span>
                </button>
                <button onclick="switchTab('wordCards')" class="tab-btn flex flex-col items-center p-2 text-gray-600">
                    <i class="fas fa-clone text-xl"></i>
                    <span class="text-xs mt-1">å˜èªã‚«ãƒ¼ãƒ‰</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-96">
            <h3 class="text-lg font-semibold mb-4">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
                <input type="text" id="adminUserId" class="w-full px-3 py-2 border border-gray-300 rounded">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="adminPassword" class="w-full px-3 py-2 border border-gray-300 rounded">
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="closeAdminLogin()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button onclick="adminLogin()" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700">
                    ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            </div>
            <div id="adminLoginError" class="text-red-500 text-sm mt-2 hidden"></div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden min-h-screen bg-gray-100 p-6">
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">ç®¡ç†è€…ãƒ‘ãƒãƒ«</h2>
                <button onclick="exitAdmin()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                    ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰çµ‚äº†
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- User Management -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h3>
                    <div id="adminUserList" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- Users will be listed here -->
                    </div>
                </div>

                <!-- Achievement Management -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆç®¡ç†</h3>
                    <button onclick="showAddAchievement()" class="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 mb-4">
                        æ–°ã—ã„ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆè¿½åŠ 
                    </button>
                    <div id="adminAchievementList" class="space-y-2 max-h-48 overflow-y-auto">
                        <!-- Achievements will be listed here -->
                    </div>
                </div>

                <!-- Chat Management -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">ãƒãƒ£ãƒƒãƒˆç®¡ç†</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span>å…¨ä½“ãƒãƒ£ãƒƒãƒˆ</span>
                            <button onclick="toggleGlobalChat()" id="globalChatToggle" class="px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700">
                                é–‰é–ä¸­
                            </button>
                        </div>
                        <button onclick="showChatModeration()" class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            ãƒãƒ£ãƒƒãƒˆæŠ•ç¨¿ç®¡ç†
                        </button>
                    </div>
                </div>

                <!-- System Settings -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h3>
                    <div class="space-y-3">
                        <button onclick="showUserStats()" class="w-full px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                            ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆ
                        </button>
                        <button onclick="exportData()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">
                            ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </button>
                    </div>
                </div>

                <!-- Super Admin Access -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">è©³ç´°è¨­å®š</h3>
                    <button onclick="showSuperAdminLogin()" class="w-full px-4 py-2 bg-gray-800 text-white rounded hover:bg-gray-900">
                        è¶…ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Super Admin Login Modal -->
    <div id="superAdminLoginModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-96">
            <h3 class="text-lg font-semibold mb-4">è¶…ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">åå‰</label>
                <input type="text" id="superAdminName" class="w-full px-3 py-2 border border-gray-300 rounded">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
                <input type="text" id="superAdminId" class="w-full px-3 py-2 border border-gray-300 rounded">
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="closeSuperAdminLogin()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button onclick="superAdminLogin()" class="px-4 py-2 bg-gray-800 text-white rounded hover:bg-gray-900">
                    ã‚¢ã‚¯ã‚»ã‚¹
                </button>
            </div>
            <div id="superAdminLoginError" class="text-red-500 text-sm mt-2 hidden"></div>
        </div>
    </div>

    <!-- Super Admin Panel -->
    <div id="superAdminPanel" class="hidden min-h-screen bg-gray-900 text-white p-6">
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">è¶…ç®¡ç†è€…ãƒ‘ãƒãƒ«</h2>
                <button onclick="exitSuperAdmin()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                    è¶…ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰çµ‚äº†
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Achievement Editor -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4">ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆè©³ç´°è¨­å®š</h3>
                    <div id="achievementEditor" class="space-y-4">
                        <!-- Achievement editing interface -->
                    </div>
                </div>

                <!-- Admin User Management -->
                <div class="bg-gray-800 rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4">ç®¡ç†è€…æ¨©é™è¨­å®š</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠ</label>
                        <select id="adminUserSelect" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white">
                            <option value="">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š</label>
                        <input type="password" id="setAdminPassword" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white">
                    </div>
                    <button onclick="setUserAsAdmin()" class="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        ç®¡ç†è€…æ¨©é™ã‚’ä»˜ä¸
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentUser = null;
        let currentChat = null;
        let timerInterval = null;
        let currentTime = 25 * 60; // 25 minutes in seconds
        let isTimerRunning = false;
        let isBreakTime = false;
        let studyChart = null;
        let currentCardSet = null;
        let currentCardIndex = 0;

        // Initialize app data structure
        const appData = {
            users: {
                '1h1y2k7w4a': {
                    name: 'æ—©å·',
                    id: '1h1y2k7w4a',
                    password: 'kousuke2007',
                    level: 1,
                    exp: 0,
                    points: 0,
                    totalStudyTime: 0,
                    studyHistory: [],
                    achievements: ['beginner'],
                    expMultiplier: 1.0,
                    pointMultiplier: 1.0,
                    profileImage: null,
                    isAdmin: true,
                    adminPassword: 'kousuke2007'
                }
            },
            posts: [],
            chats: {},
            groups: {},
            cardSets: {},
            achievements: {
                'beginner': {
                    name: 'ã¯ã˜ã‚ã®ä¸€æ­©',
                    description: 'åˆå›ãƒ­ã‚°ã‚¤ãƒ³',
                    condition: 'login_first',
                    image: 'ğŸŒ…',
                    rarity: 'common'
                },
                'three_days': {
                    name: '3æ—¥åŠä¸»ã˜ã‚ƒãªã„!',
                    description: '3æ—¥é€£ç¶šãƒ­ã‚°ã‚¤ãƒ³',
                    condition: 'login_consecutive_3',
                    image: 'ğŸŒ±',
                    rarity: 'common'
                },
                'focus_30min': {
                    name: 'é›†ä¸­ã®30åˆ†',
                    description: '30åˆ†ã‚¿ã‚¤ãƒãƒ¼ã‚’å®Œäº†',
                    condition: 'timer_complete_30',
                    image: 'ğŸ•',
                    rarity: 'common'
                },
                'first_chat': {
                    name: 'åˆãƒãƒ£ãƒƒãƒˆ!',
                    description: 'åˆå›ãƒãƒ£ãƒƒãƒˆæŠ•ç¨¿',
                    condition: 'chat_first',
                    image: 'ğŸ’¬',
                    rarity: 'common'
                },
                'room_debut': {
                    name: 'ãƒ«ãƒ¼ãƒ ãƒ‡ãƒ“ãƒ¥ãƒ¼',
                    description: 'ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆå‚åŠ ',
                    condition: 'group_join_first',
                    image: 'ğŸšª',
                    rarity: 'common'
                },
                'timer_expert_1': {
                    name: 'ã‚¿ã‚¤ãƒãƒ¼è·äººLv.1',
                    description: 'ã‚¿ã‚¤ãƒãƒ¼ã‚’3å›ä½¿ç”¨',
                    condition: 'timer_use_3',
                    image: 'â°',
                    rarity: 'common'
                },
                'week_streak': {
                    name: '1é€±é–“ã®è»Œè·¡',
                    description: '7æ—¥é€£ç¶šãƒ­ã‚°ã‚¤ãƒ³',
                    condition: 'login_consecutive_7',
                    image: 'ğŸ“…',
                    rarity: 'uncommon'
                },
                'pomodoro_master_1': {
                    name: 'ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ãƒã‚¹ã‚¿ãƒ¼Lv.1',
                    description: 'ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚’10å›å®Œäº†',
                    condition: 'pomodoro_complete_10',
                    image: 'ğŸ…ğŸ‘‘',
                    rarity: 'uncommon'
                },
                'morning_person': {
                    name: 'æœæ´»ã®æ°‘',
                    description: 'æœ6æ™‚å‰ã«å‹‰å¼·é–‹å§‹ã‚’5å›',
                    condition: 'study_morning_5',
                    image: 'ğŸŒ„',
                    rarity: 'uncommon'
                },
                'night_warrior': {
                    name: 'å¤œãµã‹ã—æˆ¦å£«',
                    description: 'å¤œ10æ™‚ä»¥é™ã«å‹‰å¼·ã‚’10å›',
                    condition: 'study_night_10',
                    image: 'ğŸŒ™',
                    rarity: 'uncommon'
                },
                'ten_hours': {
                    name: '10æ™‚é–“çªç ´!',
                    description: 'ç´¯è¨ˆå‹‰å¼·æ™‚é–“10æ™‚é–“é”æˆ',
                    condition: 'study_total_600',
                    image: 'â±ï¸',
                    rarity: 'uncommon'
                },
                'schedule_master_1': {
                    name: 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒã‚¹ã‚¿ãƒ¼Lv.1',
                    description: '1æ—¥5æ™‚é–“å‹‰å¼·ã‚’3å›',
                    condition: 'study_daily_300_3',
                    image: 'ğŸ“‹',
                    rarity: 'uncommon'
                },
                'teacher': {
                    name: 'æ•™ãˆã‚‹ã£ã¦ã‚€ãšã„!',
                    description: 'æŠ•ç¨¿ã‚’5å›ä½œæˆ',
                    condition: 'post_create_5',
                    image: 'ğŸ“–',
                    rarity: 'uncommon'
                },
                'friendship': {
                    name: 'æ°—ã¥ã‘ã°ä»²é–“ã¨',
                    description: '3äººä»¥ä¸Šã®ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆä½œæˆ',
                    condition: 'group_create_3plus',
                    image: 'ğŸ¤',
                    rarity: 'uncommon'
                },
                'weekly_challenger': {
                    name: 'é€±é–“ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼',
                    description: '1é€±é–“ã§20æ™‚é–“å‹‰å¼·',
                    condition: 'study_week_1200',
                    image: 'ğŸ”ï¸',
                    rarity: 'uncommon'
                },
                'collector': {
                    name: 'ç§°å·ã‚’å¾—ã—è€…',
                    description: 'ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆã‚’10å€‹ç²å¾—',
                    condition: 'achievement_count_10',
                    image: 'ğŸ†',
                    rarity: 'uncommon'
                },
                'pomodoro_king': {
                    name: 'ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚­ãƒ³ã‚°',
                    description: 'ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã‚’100å›å®Œäº†',
                    condition: 'pomodoro_complete_100',
                    image: 'ğŸ…ğŸ‘‘ğŸ’«',
                    rarity: 'epic'
                },
                'persistence': {
                    name: 'ç¶™ç¶šã¯åŠ›ãªã‚Š',
                    description: '30æ—¥é€£ç¶šãƒ­ã‚°ã‚¤ãƒ³',
                    condition: 'login_consecutive_30',
                    image: 'ğŸ›ï¸',
                    rarity: 'epic'
                },
                'hundred_hours': {
                    name: 'å­¦ç¿’æ™‚é–“100æ™‚é–“çªç ´!',
                    description: 'ç´¯è¨ˆå‹‰å¼·æ™‚é–“100æ™‚é–“é”æˆ',
                    condition: 'study_total_6000',
                    image: 'ğŸ”¥â°',
                    rarity: 'epic'
                },
                'perfect': {
                    name: 'å®Œå…¨é”æˆè€…',
                    description: 'ç§˜å¯†ã®æ¡ä»¶ã‚’æº€ãŸã™',
                    condition: 'study_19days_4hours_3weeks',
                    image: 'ğŸ¥‡',
                    rarity: 'legendary',
                    hidden: true,
                    effect: 'exp_point_multiplier_1.5'
                }
            },
            settings: {
                globalChatEnabled: false,
                background: 'white'
            }
        };

        // Load data from localStorage
        function loadData() {
            const saved = localStorage.getItem('studyHomeData');
            if (saved) {
                const savedData = JSON.parse(saved);
                // Merge with default data to ensure all properties exist
                Object.assign(appData, savedData);
                // Ensure achievements structure exists
                if (!appData.achievements) {
                    appData.achievements = {};
                }
            }
            saveData();
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('studyHomeData', JSON.stringify(appData));
        }

        // Access control
        function checkAccess() {
            const password = document.getElementById('accessPassword').value;
            if (password === '20studyhome25') {
                document.getElementById('accessScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
            } else {
                document.getElementById('accessError').classList.remove('hidden');
            }
        }

        // Authentication
        function toggleForm() {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const toggleButton = document.getElementById('toggleButton');
            
            if (loginForm.classList.contains('hidden')) {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                toggleButton.textContent = 'æ–°è¦ç™»éŒ²ã¯ã“ã¡ã‚‰';
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                toggleButton.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã¯ã“ã¡ã‚‰';
            }
        }

        function login() {
            const name = document.getElementById('loginName').value;
            const id = document.getElementById('loginId').value;
            const error = document.getElementById('loginError');
            
            error.classList.add('hidden');
            
            if (!name || !id) {
                error.textContent = 'åå‰ã¨IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                error.classList.remove('hidden');
                return;
            }
            
            const user = Object.values(appData.users).find(u => u.name === name && u.id === id);
            if (user) {
                currentUser = user;
                startApp();
            } else {
                error.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                error.classList.remove('hidden');
            }
        }

        function register() {
            const name = document.getElementById('registerName').value;
            const id = document.getElementById('registerId').value;
            const error = document.getElementById('loginError');
            
            error.classList.add('hidden');
            
            if (!name || !id) {
                error.textContent = 'åå‰ã¨IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                error.classList.remove('hidden');
                return;
            }
            
            if (appData.users[id]) {
                error.textContent = 'ã“ã®IDã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™';
                error.classList.remove('hidden');
                return;
            }
            
            const newUser = {
                name: name,
                id: id,
                level: 1,
                exp: 0,
                points: 0,
                totalStudyTime: 0,
                studyHistory: [],
                achievements: ['beginner'],
                expMultiplier: 1.0,
                pointMultiplier: 1.0,
                profileImage: null,
                isAdmin: false,
                adminPassword: null
            };
            
            appData.users[id] = newUser;
            currentUser = newUser;
            saveData();
            
            checkAchievements();
            startApp();
        }

        function startApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            updateUserDisplay();
            updatePrivateChatOptions();
            updateAdminUserList();
            loadPosts();
            loadChats();
            loadCardSets();
            initializeChart();
            updateAchievementsDisplay();
            
            // Start periodic save and sync
            setInterval(saveData, 5000);
            setInterval(syncData, 1000);
        }

        function logout() {
            currentUser = null;
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('superAdminPanel').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // Clear form fields
            document.getElementById('loginName').value = '';
            document.getElementById('loginId').value = '';
        }

        // Tab switching
        function switchTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tab + 'Tab').classList.add('active');
            
            // Update button colors
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('text-blue-600');
                btn.classList.add('text-gray-600');
            });
            event.target.closest('.tab-btn').classList.remove('text-gray-600');
            event.target.closest('.tab-btn').classList.add('text-blue-600');
            
            // Tab-specific actions
            if (tab === 'profile') {
                updateProfileTab();
            } else if (tab === 'timer') {
                updateStudyChart();
            }
        }

        // User display updates
        function updateUserDisplay() {
            if (!currentUser) return;
            
            document.getElementById('userPoints').textContent = currentUser.points || 0;
            document.getElementById('userExp').textContent = currentUser.exp || 0;
            document.getElementById('userLevel').textContent = currentUser.level || 1;
            document.getElementById('headerUserName').textContent = currentUser.name;
            
            // Update user frame based on total exp
            const totalExp = currentUser.exp || 0;
            const frameElement = document.querySelector('#userProfileHeader .user-frame');
            frameElement.className = 'w-8 h-8 rounded-full bg-gray-300 user-frame flex items-center justify-center';
            
            if (totalExp >= 30000000) frameElement.classList.add('frame-diamond');
            else if (totalExp >= 5900000) frameElement.classList.add('frame-gold');
            else if (totalExp >= 600000) frameElement.classList.add('frame-silver');
            else if (totalExp >= 18000) frameElement.classList.add('frame-red');
            else if (totalExp >= 6000) frameElement.classList.add('frame-green');
            else frameElement.classList.add('frame-blue');
        }

        function updateProfileTab() {
            if (!currentUser) return;
            
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('profileLevel').textContent = currentUser.level || 1;
            document.getElementById('profilePoints').textContent = currentUser.points || 0;
            document.getElementById('profileExp').textContent = currentUser.exp || 0;
            document.getElementById('totalStudyTime').textContent = (currentUser.totalStudyTime || 0) + 'åˆ†';
            document.getElementById('editName').value = currentUser.name;
            
            // Update profile image
            if (currentUser.profileImage) {
                document.getElementById('profileIcon').innerHTML = `<img src="${currentUser.profileImage}" class="w-full h-full object-cover rounded-full">`;
            }
        }

        function saveProfile() {
            if (!currentUser) return;
            
            currentUser.name = document.getElementById('editName').value;
            saveData();
            updateUserDisplay();
            alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }

        function changeProfileImage() {
            document.getElementById('profileImageInput').click();
        }

        document.getElementById('profileImageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentUser.profileImage = e.target.result;
                    document.getElementById('profileIcon').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-full">`;
                    saveData();
                };
                reader.readAsDataURL(file);
            }
        });

        // Timer functionality
        function startTimer() {
            if (!isTimerRunning) {
                isTimerRunning = true;
                timerInterval = setInterval(updateTimer, 1000);
                document.getElementById('startBtn').textContent = 'å®Ÿè¡Œä¸­...';
                document.getElementById('startBtn').disabled = true;
            }
        }

        function pauseTimer() {
            if (isTimerRunning) {
                isTimerRunning = false;
                clearInterval(timerInterval);
                document.getElementById('startBtn').textContent = 'é–‹å§‹';
                document.getElementById('startBtn').disabled = false;
            }
        }

        function resetTimer() {
            pauseTimer();
            const studyMinutes = parseInt(document.getElementById('studyTime').value) || 25;
            currentTime = studyMinutes * 60;
            isBreakTime = false;
            updateTimerDisplay();
        }

        function updateTimer() {
            if (currentTime > 0) {
                currentTime--;
                updateTimerDisplay();
            } else {
                // Timer finished
                pauseTimer();
                
                if (!isBreakTime) {
                    // Study time finished
                    const studyMinutes = parseInt(document.getElementById('studyTime').value) || 25;
                    const subject = document.getElementById('timerSubject').value;
                    
                    addStudyTime(studyMinutes, subject);
                    
                    alert('å‹‰å¼·æ™‚é–“ãŒçµ‚äº†ã—ã¾ã—ãŸï¼ä¼‘æ†©æ™‚é–“ã§ã™ã€‚');
                    
                    // Start break time
                    const breakMinutes = parseInt(document.getElementById('breakTime').value) || 5;
                    currentTime = breakMinutes * 60;
                    isBreakTime = true;
                    startTimer();
                } else {
                    // Break time finished
                    alert('ä¼‘æ†©æ™‚é–“ãŒçµ‚äº†ã—ã¾ã—ãŸï¼');
                    resetTimer();
                }
            }
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(currentTime / 60);
            const seconds = currentTime % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function addStudyTime(minutes, subject) {
            if (!currentUser) return;
            
            const studySession = {
                date: new Date().toISOString().split('T')[0],
                minutes: minutes,
                subject: subject,
                timestamp: Date.now()
            };
            
            if (!currentUser.studyHistory) currentUser.studyHistory = [];
            currentUser.studyHistory.push(studySession);
            
            currentUser.totalStudyTime = (currentUser.totalStudyTime || 0) + minutes;
            
            // Add experience and points
            const baseExp = minutes * 10;
            const basePoints = Math.floor(minutes / 30) * 50;
            
            const finalExp = Math.floor(baseExp * currentUser.expMultiplier * (currentUser.level * 1.01));
            const finalPoints = Math.floor(basePoints * currentUser.pointMultiplier * (currentUser.level * 1.01));
            
            currentUser.exp = (currentUser.exp || 0) + finalExp;
            currentUser.points = (currentUser.points || 0) + finalPoints;
            
            // Check for level up
            checkLevelUp();
            
            // Check achievements
            checkAchievements();
            
            saveData();
            updateUserDisplay();
            updateStudyChart();
        }

        function addManualStudyTime() {
            const subject = document.getElementById('manualSubject').value;
            const minutes = parseInt(document.getElementById('manualTime').value);
            
            if (minutes > 0) {
                addStudyTime(minutes, subject);
                document.getElementById('manualTime').value = '';
                alert(`${minutes}åˆ†ã®å‹‰å¼·æ™‚é–“ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼`);
            }
        }

        function checkLevelUp() {
            if (!currentUser) return;
            
            const requiredExp = calculateRequiredExp(currentUser.level);
            if (currentUser.exp >= requiredExp) {
                currentUser.level++;
                currentUser.exp -= requiredExp;
                
                // Increase multipliers slightly
                currentUser.expMultiplier *= 1.01;
                currentUser.pointMultiplier *= 1.01;
                
                alert(`ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼ãƒ¬ãƒ™ãƒ« ${currentUser.level} ã«ãªã‚Šã¾ã—ãŸï¼`);
                updateUserDisplay();
            }
        }

        function calculateRequiredExp(level) {
            if (level === 1) return 100;
            return Math.floor(100 * Math.pow(1.3, level - 1));
        }

        // Chart functionality
        function initializeChart() {
            const ctx = document.getElementById('studyChart').getContext('2d');
            
            studyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'å‹‰å¼·æ™‚é–“ï¼ˆåˆ†ï¼‰',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.3
                    }, {
                        label: 'å¹³å‡å‹‰å¼·æ™‚é–“ï¼ˆåˆ†ï¼‰',
                        data: [],
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderDash: [5, 5]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            updateStudyChart();
        }

        function updateStudyChart() {
            if (!studyChart || !currentUser) return;
            
            const period = document.getElementById('chartPeriod').value;
            const days = period === 'week' ? 7 : 30;
            
            const labels = [];
            const data = [];
            const avgData = [];
            
            // Calculate average from all users
            const allUsers = Object.values(appData.users);
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                labels.push(date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }));
                
                // User's data
                const userDayMinutes = (currentUser.studyHistory || [])
                    .filter(session => session.date === dateStr)
                    .reduce((sum, session) => sum + session.minutes, 0);
                data.push(userDayMinutes);
                
                // Average data
                const allDayMinutes = allUsers.map(user => 
                    (user.studyHistory || [])
                        .filter(session => session.date === dateStr)
                        .reduce((sum, session) => sum + session.minutes, 0)
                );
                const avgMinutes = allDayMinutes.length > 0 ? 
                    allDayMinutes.reduce((sum, minutes) => sum + minutes, 0) / allDayMinutes.length : 0;
                avgData.push(Math.round(avgMinutes));
            }
            
            studyChart.data.labels = labels;
            studyChart.data.datasets[0].data = data;
            studyChart.data.datasets[1].data = avgData;
            studyChart.update();
        }

        // Posts functionality
        function createPost() {
            const content = document.getElementById('postContent').value.trim();
            const subject = document.getElementById('postSubject').value;
            const fileInput = document.getElementById('postFile');
            
            if (!content) {
                alert('æŠ•ç¨¿å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const post = {
                id: Date.now(),
                author: currentUser.name,
                authorId: currentUser.id,
                content: content,
                subject: subject,
                timestamp: Date.now(),
                file: null
            };
            
            if (fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    post.file = {
                        name: fileInput.files[0].name,
                        type: fileInput.files[0].type,
                        data: e.target.result
                    };
                    
                    appData.posts.unshift(post);
                    saveData();
                    loadPosts();
                    
                    document.getElementById('postContent').value = '';
                    fileInput.value = '';
                    
                    checkAchievements();
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                appData.posts.unshift(post);
                saveData();
                loadPosts();
                
                document.getElementById('postContent').value = '';
                checkAchievements();
            }
        }

        function loadPosts() {
            const postsList = document.getElementById('postsList');
            postsList.innerHTML = '';
            
            appData.posts.forEach(post => {
                const postDiv = document.createElement('div');
                postDiv.className = 'bg-white rounded-lg shadow p-4';
                
                let fileHtml = '';
                if (post.file) {
                    if (post.file.type.startsWith('image/')) {
                        fileHtml = `<img src="${post.file.data}" class="max-w-full h-48 object-cover rounded mt-2">`;
                    } else if (post.file.type === 'application/pdf') {
                        fileHtml = `<div class="mt-2 p-2 bg-gray-100 rounded flex items-center">
                            <i class="fas fa-file-pdf text-red-500 mr-2"></i>
                            <span>${post.file.name}</span>
                            <a href="${post.file.data}" target="_blank" class="ml-auto text-blue-600 hover:text-blue-800">é–‹ã</a>
                        </div>`;
                    }
                }
                
                postDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center space-x-2">
                            <div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center">
                                <i class="fas fa-user text-gray-600 text-sm"></i>
                            </div>
                            <div>
                                <div class="font-semibold text-sm">${post.author}</div>
                                <div class="text-xs text-gray-500">${new Date(post.timestamp).toLocaleString('ja-JP')}</div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">${getSubjectName(post.subject)}</span>
                            ${post.authorId === currentUser.id ? 
                                `<button onclick="deletePost(${post.id})" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-trash text-xs"></i>
                                </button>` : ''}
                        </div>
                    </div>
                    <div class="text-gray-800 mb-2">${post.content}</div>
                    ${fileHtml}
                `;
                
                postsList.appendChild(postDiv);
            });
        }

        function deletePost(postId) {
            if (confirm('ã“ã®æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                appData.posts = appData.posts.filter(post => post.id !== postId);
                saveData();
                loadPosts();
            }
        }

        function getSubjectName(subject) {
            const subjects = {
                'general': 'ä¸€èˆ¬',
                'math': 'æ•°å­¦',
                'english': 'è‹±èª',
                'science': 'ç†ç§‘',
                'social': 'ç¤¾ä¼š',
                'japanese': 'å›½èª'
            };
            return subjects[subject] || subject;
        }

        // Chat functionality
        function loadChats() {
            updateChatList();
        }

        function updateChatList() {
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = '';
            
            // Add groups
            Object.entries(appData.groups).forEach(([groupId, group]) => {
                if (group.members.includes(currentUser.id)) {
                    const chatDiv = document.createElement('div');
                    chatDiv.className = 'p-2 bg-gray-100 rounded cursor-pointer hover:bg-gray-200';
                    chatDiv.textContent = group.name;
                    chatDiv.onclick = () => openChat('group_' + groupId);
                    chatList.appendChild(chatDiv);
                }
            });
        }

        function updatePrivateChatOptions() {
            const select = document.getElementById('privateChatSelect');
            select.innerHTML = '<option value="">ç›¸æ‰‹ã‚’é¸æŠ</option>';
            
            Object.values(appData.users).forEach(user => {
                if (user.id !== currentUser.id) {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    select.appendChild(option);
                }
            });
        }

        function openPrivateChat() {
            const select = document.getElementById('privateChatSelect');
            const targetUserId = select.value;
            
            if (targetUserId) {
                const chatId = [currentUser.id, targetUserId].sort().join('_');
                openChat('private_' + chatId);
            }
        }

        function openChat(chatId) {
            currentChat = chatId;
            
            if (!appData.chats[chatId]) {
                appData.chats[chatId] = { messages: [] };
            }
            
            // Update header
            const header = document.getElementById('chatHeader');
            let chatName = '';
            
            if (chatId.startsWith('group_')) {
                const groupId = chatId.replace('group_', '');
                chatName = appData.groups[groupId]?.name || 'ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆ';
            } else if (chatId.startsWith('private_')) {
                const userIds = chatId.replace('private_', '').split('_');
                const otherUserId = userIds.find(id => id !== currentUser.id);
                const otherUser = appData.users[otherUserId];
                chatName = otherUser ? `${otherUser.name} ã¨ã®å€‹äººãƒãƒ£ãƒƒãƒˆ` : 'å€‹äººãƒãƒ£ãƒƒãƒˆ';
            }
            
            header.innerHTML = `<h4 class="font-semibold">${chatName}</h4>`;
            
            // Show input and load messages
            document.getElementById('chatInput').classList.remove('hidden');
            loadChatMessages();
        }

        function loadChatMessages() {
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.innerHTML = '';
            
            if (!currentChat || !appData.chats[currentChat]) return;
            
            appData.chats[currentChat].messages.forEach(message => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `mb-3 ${message.senderId === currentUser.id ? 'text-right' : 'text-left'}`;
                
                messageDiv.innerHTML = `
                    <div class="inline-block max-w-xs lg:max-w-md px-3 py-2 rounded-lg ${
                        message.senderId === currentUser.id 
                            ? 'bg-blue-600 text-white' 
                            : 'bg-gray-200 text-gray-800'
                    }">
                        <div class="text-xs opacity-75 mb-1">${message.senderName}</div>
                        <div>${message.content}</div>
                        <div class="text-xs opacity-75 mt-1">
                            ${new Date(message.timestamp).toLocaleTimeString('ja-JP')}
                        </div>
                        ${message.senderId === currentUser.id || (currentUser.isAdmin && currentUser.adminPassword) ? 
                            `<button onclick="deleteMessage('${currentChat}', ${message.timestamp})" class="text-xs opacity-75 hover:opacity-100 ml-2">
                                å‰Šé™¤
                            </button>` : ''}
                    </div>
                `;
                
                messagesDiv.appendChild(messageDiv);
            });
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content || !currentChat) return;
            
            const message = {
                senderId: currentUser.id,
                senderName: currentUser.name,
                content: content,
                timestamp: Date.now()
            };
            
            if (!appData.chats[currentChat]) {
                appData.chats[currentChat] = { messages: [] };
            }
            
            appData.chats[currentChat].messages.push(message);
            saveData();
            loadChatMessages();
            
            input.value = '';
            checkAchievements();
        }

        function deleteMessage(chatId, timestamp) {
            if (confirm('ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                appData.chats[chatId].messages = appData.chats[chatId].messages.filter(
                    msg => msg.timestamp !== timestamp
                );
                saveData();
                loadChatMessages();
            }
        }

        // Group management
        function showGroupCreate() {
            const modal = document.getElementById('groupCreateModal');
            const memberSelect = document.getElementById('groupMemberSelect');
            
            memberSelect.innerHTML = '';
            Object.values(appData.users).forEach(user => {
                if (user.id !== currentUser.id) {
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-2';
                    label.innerHTML = `
                        <input type="checkbox" value="${user.id}">
                        <span>${user.name}</span>
                    `;
                    memberSelect.appendChild(label);
                }
            });
            
            modal.classList.remove('hidden');
        }

        function closeGroupCreate() {
            document.getElementById('groupCreateModal').classList.add('hidden');
            document.getElementById('groupName').value = '';
        }

        function createGroup() {
            const groupName = document.getElementById('groupName').value.trim();
            const selectedMembers = Array.from(document.querySelectorAll('#groupMemberSelect input:checked'))
                .map(cb => cb.value);
            
            if (!groupName) {
                alert('ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (selectedMembers.length === 0) {
                alert('ãƒ¡ãƒ³ãƒãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const groupId = Date.now().toString();
            appData.groups[groupId] = {
                name: groupName,
                members: [currentUser.id, ...selectedMembers],
                creator: currentUser.id,
                created: Date.now()
            };
            
            saveData();
            closeGroupCreate();
            updateChatList();
            checkAchievements();
        }

        // Word Cards functionality
        function loadCardSets() {
            const cardSetsList = document.getElementById('cardSetsList');
            cardSetsList.innerHTML = '';
            
            Object.entries(appData.cardSets).forEach(([setId, cardSet]) => {
                if (cardSet.creatorId === currentUser.id || cardSet.isPublic) {
                    const setDiv = document.createElement('div');
                    setDiv.className = 'bg-white rounded-lg shadow p-4';
                    
                    setDiv.innerHTML = `
                        <h4 class="font-semibold mb-2">${cardSet.name}</h4>
                        <p class="text-sm text-gray-600 mb-3">${cardSet.cards.length}æšã®ã‚«ãƒ¼ãƒ‰</p>
                        <div class="flex justify-between items-center">
                            <button onclick="studyCardSet('${setId}')" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                                å­¦ç¿’é–‹å§‹
                            </button>
                            ${cardSet.creatorId === currentUser.id ? `
                                <button onclick="deleteCardSet('${setId}')" class="px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700">
                                    å‰Šé™¤
                                </button>
                            ` : ''}
                        </div>
                    `;
                    
                    cardSetsList.appendChild(setDiv);
                }
            });
        }

        function showCreateCardSet() {
            document.getElementById('createCardSetModal').classList.remove('hidden');
            document.getElementById('cardInputs').innerHTML = `
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" class="px-2 py-1 border border-gray-300 rounded text-sm" placeholder="å˜èªãƒ»å•é¡Œ">
                    <input type="text" class="px-2 py-1 border border-gray-300 rounded text-sm" placeholder="æ„å‘³ãƒ»ç­”ãˆ">
                </div>
            `;
        }

        function closeCreateCardSet() {
            document.getElementById('createCardSetModal').classList.add('hidden');
            document.getElementById('cardSetName').value = '';
            document.getElementById('cardSetPublic').checked = false;
        }

        function addCardInput() {
            const cardInputs = document.getElementById('cardInputs');
            const newCard = document.createElement('div');
            newCard.className = 'grid grid-cols-2 gap-2';
            newCard.innerHTML = `
                <input type="text" class="px-2 py-1 border border-gray-300 rounded text-sm" placeholder="å˜èªãƒ»å•é¡Œ">
                <input type="text" class="px-2 py-1 border border-gray-300 rounded text-sm" placeholder="æ„å‘³ãƒ»ç­”ãˆ">
            `;
            cardInputs.appendChild(newCard);
        }

        function createCardSet() {
            const setName = document.getElementById('cardSetName').value.trim();
            const isPublic = document.getElementById('cardSetPublic').checked;
            
            if (!setName) {
                alert('ã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const cardInputs = document.querySelectorAll('#cardInputs > div');
            const cards = [];
            
            cardInputs.forEach(cardDiv => {
                const inputs = cardDiv.querySelectorAll('input');
                const front = inputs[0].value.trim();
                const back = inputs[1].value.trim();
                
                if (front && back) {
                    cards.push({ front, back });
                }
            });
            
            if (cards.length === 0) {
                alert('ã‚«ãƒ¼ãƒ‰ã‚’å°‘ãªãã¨ã‚‚1æšä½œæˆã—ã¦ãã ã•ã„');
                return;
            }
            
            const setId = Date.now().toString();
            appData.cardSets[setId] = {
                name: setName,
                cards: cards,
                creatorId: currentUser.id,
                isPublic: isPublic,
                created: Date.now()
            };
            
            saveData();
            closeCreateCardSet();
            loadCardSets();
        }

        function deleteCardSet(setId) {
            if (confirm('ã“ã®å˜èªã‚«ãƒ¼ãƒ‰ã‚»ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                delete appData.cardSets[setId];
                saveData();
                loadCardSets();
            }
        }

        function studyCardSet(setId) {
            currentCardSet = appData.cardSets[setId];
            currentCardIndex = 0;
            
            document.getElementById('cardSetsList').classList.add('hidden');
            document.getElementById('cardStudyArea').classList.remove('hidden');
            
            updateCardDisplay();
        }

        function exitCardStudy() {
            currentCardSet = null;
            currentCardIndex = 0;
            
            document.getElementById('cardSetsList').classList.remove('hidden');
            document.getElementById('cardStudyArea').classList.add('hidden');
        }

        function updateCardDisplay() {
            if (!currentCardSet || !currentCardSet.cards[currentCardIndex]) return;
            
            const card = currentCardSet.cards[currentCardIndex];
            
            document.getElementById('currentCardSetName').textContent = currentCardSet.name;
            document.getElementById('cardProgress').textContent = 
                `${currentCardIndex + 1} / ${currentCardSet.cards.length}`;
            document.getElementById('cardFront').textContent = card.front;
            document.getElementById('cardBack').textContent = card.back;
            
            // Reset card to front
            document.querySelector('.word-card').classList.remove('flipped');
        }

        function flipCard() {
            document.querySelector('.word-card').classList.toggle('flipped');
        }

        function previousCard() {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                updateCardDisplay();
            }
        }

        function nextCard() {
            if (currentCardIndex < currentCardSet.cards.length - 1) {
                currentCardIndex++;
                updateCardDisplay();
            }
        }

        // Achievements system
        function checkAchievements() {
            if (!currentUser) return;
            
            const achievements = currentUser.achievements || [];
            let newAchievements = [];
            
            // Check each achievement condition
            Object.entries(appData.achievements).forEach(([achievementId, achievement]) => {
                if (!achievements.includes(achievementId)) {
                    if (checkAchievementCondition(achievement.condition)) {
                        achievements.push(achievementId);
                        newAchievements.push(achievement.name);
                        
                        // Apply achievement effects
                        if (achievement.effect === 'exp_point_multiplier_1.5') {
                            currentUser.expMultiplier *= 1.5;
                            currentUser.pointMultiplier *= 1.5;
                        }
                    }
                }
            });
            
            currentUser.achievements = achievements;
            saveData();
            
            if (newAchievements.length > 0) {
                alert(`ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆç²å¾—ï¼\n${newAchievements.join('\n')}`);
                updateAchievementsDisplay();
            }
        }

        function checkAchievementCondition(condition) {
            if (!currentUser) return false;
            
            const studyHistory = currentUser.studyHistory || [];
            const totalStudyTime = currentUser.totalStudyTime || 0;
            const posts = appData.posts.filter(post => post.authorId === currentUser.id);
            
            switch (condition) {
                case 'login_first':
                    return true; // Awarded on registration
                
                case 'login_consecutive_3':
                case 'login_consecutive_7':
                case 'login_consecutive_30':
                    const days = parseInt(condition.split('_')[2]);
                    return checkConsecutiveLogins(days);
                
                case 'timer_complete_30':
                    return studyHistory.some(session => session.minutes >= 30);
                
                case 'timer_use_3':
                    return studyHistory.length >= 3;
                
                case 'pomodoro_complete_10':
                case 'pomodoro_complete_100':
                    const count = parseInt(condition.split('_')[2]);
                    return studyHistory.filter(session => session.minutes === 25).length >= count;
                
                case 'study_morning_5':
                    return studyHistory.filter(session => {
                        const hour = new Date(session.timestamp).getHours();
                        return hour < 6;
                    }).length >= 5;
                
                case 'study_night_10':
                    return studyHistory.filter(session => {
                        const hour = new Date(session.timestamp).getHours();
                        return hour >= 22;
                    }).length >= 10;
                
                case 'study_total_600':
                    return totalStudyTime >= 600; // 10 hours
                
                case 'study_total_6000':
                    return totalStudyTime >= 6000; // 100 hours
                
                case 'study_daily_300_3':
                    const dailyTotals = {};
                    studyHistory.forEach(session => {
                        if (!dailyTotals[session.date]) dailyTotals[session.date] = 0;
                        dailyTotals[session.date] += session.minutes;
                    });
                    return Object.values(dailyTotals).filter(total => total >= 300).length >= 3;
                
                case 'post_create_5':
                    return posts.length >= 5;
                
                case 'chat_first':
                    return Object.values(appData.chats).some(chat => 
                        chat.messages && chat.messages.some(msg => msg.senderId === currentUser.id)
                    );
                
                case 'group_join_first':
                    return Object.values(appData.groups).some(group => 
                        group.members.includes(currentUser.id)
                    );
                
                case 'group_create_3plus':
                    return Object.values(appData.groups).some(group => 
                        group.creator === currentUser.id && group.members.length >= 3
                    );
                
                case 'study_week_1200':
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    const recentSessions = studyHistory.filter(session => 
                        new Date(session.timestamp) >= weekAgo
                    );
                    return recentSessions.reduce((sum, session) => sum + session.minutes, 0) >= 1200;
                
                case 'achievement_count_10':
                    return (currentUser.achievements || []).length >= 10;
                
                case 'study_19days_4hours_3weeks':
                    // Secret achievement: 19 days of 4+ hours study within 3 weeks
                    const threeWeeksAgo = new Date();
                    threeWeeksAgo.setDate(threeWeeksAgo.getDate() - 21);
                    
                    const recentDays = {};
                    studyHistory.forEach(session => {
                        if (new Date(session.timestamp) >= threeWeeksAgo) {
                            if (!recentDays[session.date]) recentDays[session.date] = 0;
                            recentDays[session.date] += session.minutes;
                        }
                    });
                    
                    return Object.values(recentDays).filter(total => total >= 240).length >= 19;
                
                default:
                    return false;
            }
        }

        function checkConsecutiveLogins(requiredDays) {
            // For demo purposes, we'll simulate this check
            // In a real app, you'd track login dates
            return Math.random() > 0.7; // Random chance for demo
        }

        function updateAchievementsDisplay() {
            const achievementsList = document.getElementById('achievementsList');
            achievementsList.innerHTML = '';
            
            const userAchievements = currentUser.achievements || [];
            
            Object.entries(appData.achievements).forEach(([achievementId, achievement]) => {
                if (!achievement.hidden || userAchievements.includes(achievementId)) {
                    const achievementDiv = document.createElement('div');
                    achievementDiv.className = `achievement-badge ${
                        userAchievements.includes(achievementId) ? 'bg-yellow-100 border-2 border-yellow-400' : 'bg-gray-100 border-2 border-gray-300'
                    }`;
                    achievementDiv.title = achievement.description;
                    
                    achievementDiv.innerHTML = `
                        <div class="text-center">
                            <div class="text-2xl">${achievement.image}</div>
                            <div class="text-xs mt-1 font-bold ${
                                userAchievements.includes(achievementId) ? 'text-yellow-800' : 'text-gray-500'
                            }">${achievement.name}</div>
                        </div>
                    `;
                    
                    achievementsList.appendChild(achievementDiv);
                }
            });
        }

        // Settings functionality
        function changeBackground(color) {
            document.body.style.background = color;
            appData.settings.background = color;
            saveData();
        }

        document.getElementById('backgroundImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.body.style.backgroundImage = `url(${e.target.result})`;
                    document.body.style.backgroundSize = 'cover';
                    document.body.style.backgroundPosition = 'center';
                    appData.settings.backgroundImage = e.target.result;
                    saveData();
                };
                reader.readAsDataURL(file);
            }
        });

        function buyExpBoost() {
            const price = parseInt(document.getElementById('expBoostPrice').textContent);
            
            if (currentUser.points >= price) {
                currentUser.points -= price;
                currentUser.expMultiplier *= 1.1;
                
                // Increase price for next purchase
                const newPrice = Math.floor(price * 1.3);
                document.getElementById('expBoostPrice').textContent = newPrice;
                
                updateUserDisplay();
                saveData();
                alert('çµŒé¨“å€¤ãƒ–ãƒ¼ã‚¹ãƒˆã‚’è³¼å…¥ã—ã¾ã—ãŸï¼');
            } else {
                alert('ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“');
            }
        }

        function buyDoubleBoost() {
            const price = parseInt(document.getElementById('doubleBoostPrice').textContent);
            
            if (currentUser.points >= price) {
                currentUser.points -= price;
                currentUser.expMultiplier *= 1.2;
                currentUser.pointMultiplier *= 1.2;
                
                // Increase price for next purchase
                const newPrice = Math.floor(price * 1.3);
                document.getElementById('doubleBoostPrice').textContent = newPrice;
                
                updateUserDisplay();
                saveData();
                alert('ãƒ€ãƒ–ãƒ«ãƒ–ãƒ¼ã‚¹ãƒˆã‚’è³¼å…¥ã—ã¾ã—ãŸï¼');
            } else {
                alert('ãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“');
            }
        }

        // Admin functionality
        function showAdminLogin() {
            document.getElementById('adminLoginModal').classList.remove('hidden');
        }

        function closeAdminLogin() {
            document.getElementById('adminLoginModal').classList.add('hidden');
            document.getElementById('adminLoginError').classList.add('hidden');
        }

        function adminLogin() {
            const userId = document.getElementById('adminUserId').value;
            const password = document.getElementById('adminPassword').value;
            const error = document.getElementById('adminLoginError');
            
            error.classList.add('hidden');
            
            const user = appData.users[userId];
            if (user && user.isAdmin && user.adminPassword === password) {
                closeAdminLogin();
                showAdminPanel();
            } else {
                error.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
                error.classList.remove('hidden');
            }
        }

        function showAdminPanel() {
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
            updateAdminUserList();
        }

        function exitAdmin() {
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        function updateAdminUserList() {
            const userList = document.getElementById('adminUserList');
            userList.innerHTML = '';
            
            Object.values(appData.users).forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'flex justify-between items-center p-2 bg-gray-100 rounded';
                
                userDiv.innerHTML = `
                    <div>
                        <div class="font-semibold">${user.name}</div>
                        <div class="text-sm text-gray-600">Lv.${user.level} - ${user.totalStudyTime || 0}åˆ†</div>
                    </div>
                    <button onclick="banUser('${user.id}')" class="px-2 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700">
                        BAN
                    </button>
                `;
                
                userList.appendChild(userDiv);
            });
        }

        function banUser(userId) {
            if (confirm(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${appData.users[userId].name} ã‚’ã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢ã«ã—ã¾ã™ã‹ï¼Ÿ`)) {
                delete appData.users[userId];
                saveData();
                updateAdminUserList();
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢ã«ã—ã¾ã—ãŸ');
            }
        }

        function toggleGlobalChat() {
            appData.settings.globalChatEnabled = !appData.settings.globalChatEnabled;
            const button = document.getElementById('globalChatToggle');
            
            if (appData.settings.globalChatEnabled) {
                button.textContent = 'é–‹æ”¾ä¸­';
                button.className = 'px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700';
            } else {
                button.textContent = 'é–‰é–ä¸­';
                button.className = 'px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700';
            }
            
            saveData();
        }

        // Super Admin functionality
        function showSuperAdminLogin() {
            document.getElementById('superAdminLoginModal').classList.remove('hidden');
        }

        function closeSuperAdminLogin() {
            document.getElementById('superAdminLoginModal').classList.add('hidden');
            document.getElementById('superAdminLoginError').classList.add('hidden');
        }

        function superAdminLogin() {
            const name = document.getElementById('superAdminName').value;
            const id = document.getElementById('superAdminId').value;
            const error = document.getElementById('superAdminLoginError');
            
            error.classList.add('hidden');
            
            if (name === 'æ—©å·' && id === '1h1y2k7w4a') {
                closeSuperAdminLogin();
                showSuperAdminPanel();
            } else {
                error.textContent = 'ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“';
                error.classList.remove('hidden');
            }
        }

        function showSuperAdminPanel() {
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('superAdminPanel').classList.remove('hidden');
            updateSuperAdminInterface();
        }

        function exitSuperAdmin() {
            document.getElementById('superAdminPanel').classList.add('hidden');
            document.getElementById('adminPanel').classList.remove('hidden');
        }

        function updateSuperAdminInterface() {
            // Update admin user select
            const adminSelect = document.getElementById('adminUserSelect');
            adminSelect.innerHTML = '<option value="">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ</option>';
            
            Object.values(appData.users).forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                adminSelect.appendChild(option);
            });
        }

        function setUserAsAdmin() {
            const userId = document.getElementById('adminUserSelect').value;
            const password = document.getElementById('setAdminPassword').value;
            
            if (!userId || !password) {
                alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const user = appData.users[userId];
            if (user) {
                user.isAdmin = true;
                user.adminPassword = password;
                saveData();
                alert(`${user.name} ã«ç®¡ç†è€…æ¨©é™ã‚’ä»˜ä¸ã—ã¾ã—ãŸ`);
            }
        }

        // Data synchronization (simulated real-time)
        function syncData() {
            // In a real app, this would sync with a server
            // For demo purposes, we'll just update the display
            updateUserDisplay();
            
            // Simulate receiving new messages or posts
            if (Math.random() > 0.99) {
                loadPosts();
                if (currentChat) {
                    loadChatMessages();
                }
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            
            // Set up event listeners for Enter key
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            document.getElementById('accessPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkAccess();
                }
            });
        });
    </script>
</body>
</html>
