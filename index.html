<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyHome - オンライン学習コミュニティ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .hidden { display: none; }
        .notification { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            z-index: 1000; 
            padding: 15px; 
            border-radius: 8px; 
            background: #10b981; 
            color: white; 
            opacity: 0; 
            transition: opacity 0.3s;
        }
        .notification.show { opacity: 1; }
        .achievement-badge {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 5px;
            font-size: 24px;
            position: relative;
        }
        .user-frame-blue { border: 3px solid #3b82f6; }
        .user-frame-green { border: 3px solid #10b981; }
        .user-frame-red { border: 3px solid #ef4444; }
        .user-frame-silver { border: 3px solid #94a3b8; }
        .user-frame-gold { border: 3px solid #f59e0b; }
        .user-frame-diamond { border: 3px solid linear-gradient(45deg, #e0e7ff, #c7d2fe, #a5b4fc); }
        .timer-display {
            font-size: 3rem;
            font-weight: bold;
            font-family: monospace;
        }
        .chat-message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 8px;
            background: #f3f4f6;
        }
        .flashcard {
            perspective: 1000px;
            width: 300px;
            height: 200px;
            margin: 10px auto;
        }
        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.8s;
            transform-style: preserve-3d;
            cursor: pointer;
        }
        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }
        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
        }
        .flashcard-front {
            background: #3b82f6;
            color: white;
        }
        .flashcard-back {
            background: #10b981;
            color: white;
            transform: rotateY(180deg);
        }
    </style>
</head>
<body class="bg-white min-h-screen">
    <div id="notification" class="notification"></div>

    <!-- パスワード入力画面 -->
    <div id="passwordScreen" class="min-h-screen flex items-center justify-center bg-gray-50">
        <div class="bg-white p-8 rounded-lg shadow-md w-96">
            <h1 class="text-2xl font-bold text-center mb-6">StudyHome</h1>
            <p class="text-gray-600 text-center mb-4">アクセスパスワードを入力してください</p>
            <input type="password" id="accessPassword" placeholder="パスワード" class="w-full p-3 border rounded-lg mb-4">
            <button onclick="checkPassword()" class="w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600">
                アクセス
            </button>
        </div>
    </div>

    <!-- ログイン画面 -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gray-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-md w-96">
            <h2 class="text-2xl font-bold text-center mb-6">ログイン</h2>
            <input type="text" id="loginName" placeholder="ユーザー名" class="w-full p-3 border rounded-lg mb-4">
            <input type="text" id="loginId" placeholder="ユーザーID" class="w-full p-3 border rounded-lg mb-4">
            <button onclick="login()" class="w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 mb-4">
                ログイン
            </button>
            <hr class="mb-4">
            <h3 class="text-lg font-semibold text-center mb-4">新規登録</h3>
            <input type="text" id="registerName" placeholder="ユーザー名" class="w-full p-3 border rounded-lg mb-4">
            <input type="text" id="registerId" placeholder="ユーザーID" class="w-full p-3 border rounded-lg mb-4">
            <button onclick="register()" class="w-full bg-green-500 text-white p-3 rounded-lg hover:bg-green-600">
                アカウント作成
            </button>
        </div>
    </div>

    <!-- メインアプリケーション -->
    <div id="mainApp" class="hidden">
        <!-- ヘッダー -->
        <header class="bg-white shadow-sm p-4">
            <div class="flex justify-between items-center">
                <h1 class="text-xl font-bold">StudyHome</h1>
                <div class="flex items-center space-x-4">
                    <span id="userInfo" class="text-gray-600"></span>
                    <button onclick="logout()" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- メインコンテンツ -->
        <main class="pb-20">
            <!-- 投稿・質問画面 -->
            <div id="postsScreen" class="p-4">
                <div class="mb-6">
                    <h2 class="text-xl font-bold mb-4">投稿・質問</h2>
                    <div class="bg-white rounded-lg shadow p-4 mb-4">
                        <textarea id="postContent" placeholder="質問や投稿内容を入力してください..." class="w-full p-3 border rounded-lg mb-4 h-24"></textarea>
                        <div class="flex items-center space-x-4">
                            <input type="file" id="postFile" accept=".pdf,.jpg,.jpeg,.png" class="mb-4">
                            <button onclick="submitPost()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600">
                                投稿
                            </button>
                        </div>
                    </div>
                </div>
                <div id="postsList" class="space-y-4">
                    <!-- 投稿がここに表示される -->
                </div>
            </div>

            <!-- タイマー画面 -->
            <div id="timerScreen" class="p-4 hidden">
                <h2 class="text-xl font-bold mb-4">学習タイマー</h2>
                
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="text-center mb-6">
                        <div id="timerDisplay" class="timer-display text-4xl font-mono mb-4">25:00</div>
                        <div class="space-x-4">
                            <button id="startTimer" onclick="startTimer()" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600">
                                <i class="fas fa-play"></i> 開始
                            </button>
                            <button id="pauseTimer" onclick="pauseTimer()" class="bg-yellow-500 text-white px-6 py-2 rounded-lg hover:bg-yellow-600 hidden">
                                <i class="fas fa-pause"></i> 停止
                            </button>
                            <button onclick="resetTimer()" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600">
                                <i class="fas fa-stop"></i> リセット
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">ポモドーロタイマー</label>
                            <select id="pomodoroTime" onchange="setPomodoroTimer()" class="w-full p-2 border rounded">
                                <option value="25">25分</option>
                                <option value="50">50分</option>
                                <option value="90">90分</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">カスタムタイマー（分）</label>
                            <input type="number" id="customTime" placeholder="分数を入力" class="w-full p-2 border rounded">
                            <button onclick="setCustomTimer()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                設定
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">科目</label>
                        <select id="studySubject" class="w-full p-2 border rounded">
                            <option value="数学">数学</option>
                            <option value="英語">英語</option>
                            <option value="国語">国語</option>
                            <option value="理科">理科</option>
                            <option value="社会">社会</option>
                            <option value="その他">その他</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">手動で学習時間を記録</label>
                        <div class="flex space-x-2">
                            <input type="number" id="manualHours" placeholder="時間" class="p-2 border rounded w-20">
                            <input type="number" id="manualMinutes" placeholder="分" class="p-2 border rounded w-20">
                            <button onclick="recordManualTime()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                記録
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 学習統計 -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">学習統計</h3>
                    <div class="mb-4">
                        <select id="chartPeriod" onchange="updateStudyChart()" class="p-2 border rounded">
                            <option value="week">週間</option>
                            <option value="month">月間</option>
                        </select>
                    </div>
                    <canvas id="studyChart" style="height: 300px;"></canvas>
                </div>
            </div>

            <!-- チャット画面 -->
            <div id="chatScreen" class="p-4 hidden">
                <div class="flex h-96">
                    <div class="w-1/3 border-r pr-4">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold">チャット</h2>
                            <button onclick="showCreateGroup()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                グループ作成
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <h3 class="font-semibold mb-2">個人チャット</h3>
                            <div id="usersList" class="space-y-2 max-h-32 overflow-y-auto">
                                <!-- ユーザー一覧がここに表示される -->
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="font-semibold mb-2">グループチャット</h3>
                            <div id="groupsList" class="space-y-2 max-h-32 overflow-y-auto">
                                <!-- グループ一覧がここに表示される -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="w-2/3 pl-4">
                        <div id="chatArea" class="h-80 border rounded-lg p-4 overflow-y-auto mb-4">
                            <p class="text-gray-500 text-center">チャット相手を選択してください</p>
                        </div>
                        <div class="flex">
                            <input type="text" id="chatInput" placeholder="メッセージを入力..." class="flex-1 p-2 border rounded-l-lg" disabled>
                            <button onclick="sendMessage()" class="bg-blue-500 text-white px-4 py-2 rounded-r-lg hover:bg-blue-600" disabled id="sendButton">
                                送信
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 単語カード画面 -->
            <div id="flashcardScreen" class="p-4 hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold">単語カード</h2>
                    <div class="space-x-2">
                        <button onclick="showCreateFlashcardSet()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                            新しいセット作成
                        </button>
                        <button onclick="showAddFlashcard()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600" id="addCardBtn" style="display: none;">
                            カード追加
                        </button>
                    </div>
                </div>
                
                <div id="flashcardSets" class="mb-6">
                    <!-- 単語カードセット一覧がここに表示される -->
                </div>
                
                <div id="flashcardDisplay" class="text-center">
                    <p class="text-gray-500">単語カードセットを選択してください</p>
                </div>
            </div>

            <!-- プロフィール画面 -->
            <div id="profileScreen" class="p-4 hidden">
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">プロフィール</h2>
                    <div class="text-center mb-6">
                        <div class="relative inline-block">
                            <img id="profileImage" src="https://via.placeholder.com/100" alt="プロフィール画像" class="w-24 h-24 rounded-full mx-auto mb-4 user-frame-blue">
                            <input type="file" id="profileImageInput" accept="image/*" class="hidden" onchange="updateProfileImage()">
                            <button onclick="document.getElementById('profileImageInput').click()" class="absolute bottom-0 right-0 bg-blue-500 text-white rounded-full w-8 h-8 flex items-center justify-center">
                                <i class="fas fa-camera text-xs"></i>
                            </button>
                        </div>
                        <h3 id="profileName" class="text-lg font-semibold"></h3>
                        <p class="text-sm text-gray-600">レベル <span id="userLevel">1</span></p>
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                            <div id="expBar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                        <p class="text-sm text-gray-600">EXP: <span id="userExp">0</span> / <span id="nextLevelExp">100</span></p>
                        <p class="text-sm text-gray-600">ポイント: <span id="userPoints">0</span></p>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">ユーザー名変更</label>
                            <div class="flex space-x-2">
                                <input type="text" id="newUsername" placeholder="新しいユーザー名" class="flex-1 p-2 border rounded">
                                <button onclick="updateUsername()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                    更新
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- アチーブメント -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">アチーブメント</h3>
                    <div id="achievementsList" class="grid grid-cols-4 gap-4">
                        <!-- アチーブメントがここに表示される -->
                    </div>
                </div>

                <!-- ショップ -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">ショップ</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-4 border rounded">
                            <div>
                                <p class="font-medium">経験値ブースター (1.1倍)</p>
                                <p class="text-sm text-gray-600">経験値獲得量が1.1倍になります</p>
                            </div>
                            <button onclick="buyExpBooster()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                <span id="expBoosterPrice">100</span>P
                            </button>
                        </div>
                        <div class="flex justify-between items-center p-4 border rounded">
                            <div>
                                <p class="font-medium">全能ブースター (1.2倍)</p>
                                <p class="text-sm text-gray-600">ポイントと経験値獲得量が1.2倍になります</p>
                            </div>
                            <button onclick="buyAllBooster()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                                <span id="allBoosterPrice">200</span>P
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 設定画面 -->
            <div id="settingsScreen" class="p-4 hidden">
                <h2 class="text-xl font-bold mb-4">設定</h2>
                
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">通知設定</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <label class="text-sm font-medium">静かモード</label>
                            <input type="checkbox" id="quietMode" class="toggle">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-sm font-medium">タイマー通知</label>
                            <input type="checkbox" id="timerNotification" checked class="toggle">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-sm font-medium">チャット通知</label>
                            <input type="checkbox" id="chatNotification" checked class="toggle">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="text-sm font-medium">30分ごとの通知</label>
                            <input type="checkbox" id="reminderNotification" class="toggle">
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">背景設定</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">背景色</label>
                            <input type="color" id="backgroundColor" value="#ffffff" onchange="changeBackgroundColor()" class="w-full h-10">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">背景画像</label>
                            <input type="file" id="backgroundImage" accept="image/*" onchange="changeBackgroundImage()" class="w-full">
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">関係者用</h3>
                    <div class="space-y-4">
                        <input type="password" id="adminPassword" placeholder="管理者パスワード" class="w-full p-3 border rounded-lg">
                        <button onclick="adminLogin()" class="w-full bg-red-500 text-white p-3 rounded-lg hover:bg-red-600">
                            管理画面にアクセス
                        </button>
                    </div>
                </div>
            </div>

            <!-- 管理画面 -->
            <div id="adminScreen" class="p-4 hidden">
                <h2 class="text-xl font-bold mb-4">管理画面</h2>
                
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">ユーザー管理</h3>
                    <div id="adminUsersList" class="space-y-4">
                        <!-- ユーザー一覧がここに表示される -->
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">チャット管理</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <label class="text-sm font-medium">全体チャットを開放</label>
                            <input type="checkbox" id="globalChatEnabled" onchange="toggleGlobalChat()" class="toggle">
                        </div>
                    </div>
                    <div class="mt-4">
                        <h4 class="font-medium mb-2">投稿管理</h4>
                        <div id="adminPostsList" class="space-y-2 max-h-64 overflow-y-auto">
                            <!-- 投稿一覧がここに表示される -->
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">アチーブメント管理</h3>
                    <button onclick="showCreateAchievement()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 mb-4">
                        新しいアチーブメント作成
                    </button>
                    <div id="adminAchievementsList" class="space-y-4">
                        <!-- アチーブメント一覧がここに表示される -->
                    </div>
                </div>
                
                <div class="text-center">
                    <button onclick="showSuperAdmin()" class="bg-gray-800 text-white px-6 py-3 rounded-lg hover:bg-gray-900">
                        超管理者モード
                    </button>
                </div>
            </div>
        </main>

        <!-- 下部ナビゲーション -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t">
            <div class="flex justify-around py-2">
                <button onclick="showScreen('posts')" class="flex flex-col items-center p-2 text-gray-600 hover:text-blue-600">
                    <i class="fas fa-edit text-xl mb-1"></i>
                    <span class="text-xs">投稿・質問</span>
                </button>
                <button onclick="showScreen('timer')" class="flex flex-col items-center p-2 text-gray-600 hover:text-blue-600">
                    <i class="fas fa-clock text-xl mb-1"></i>
                    <span class="text-xs">タイマー</span>
                </button>
                <button onclick="showScreen('chat')" class="flex flex-col items-center p-2 text-gray-600 hover:text-blue-600">
                    <i class="fas fa-comments text-xl mb-1"></i>
                    <span class="text-xs">チャット</span>
                </button>
                <button onclick="showScreen('flashcard')" class="flex flex-col items-center p-2 text-gray-600 hover:text-blue-600">
                    <i class="fas fa-cards-blank text-xl mb-1"></i>
                    <span class="text-xs">単語カード</span>
                </button>
                <button onclick="showScreen('profile')" class="flex flex-col items-center p-2 text-gray-600 hover:text-blue-600">
                    <i class="fas fa-user text-xl mb-1"></i>
                    <span class="text-xs">プロフィール</span>
                </button>
                <button onclick="showScreen('settings')" class="flex flex-col items-center p-2 text-gray-600 hover:text-blue-600">
                    <i class="fas fa-cog text-xl mb-1"></i>
                    <span class="text-xs">設定</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- モーダル類 -->
    <div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div id="modalContent" class="bg-white rounded-lg p-6 w-full max-w-md">
                <!-- モーダルコンテンツがここに動的に挿入される -->
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let currentUser = null;
        let currentScreen = 'posts';
        let timerInterval = null;
        let currentTime = 25 * 60; // デフォルト25分
        let isTimerRunning = false;
        let currentChatTarget = null;
        let currentChatType = 'user'; // 'user' or 'group'
        let currentFlashcardSet = null;
        let currentFlashcardIndex = 0;
        let studyChart = null;
        let reminderInterval = null;

        // データ構造
        const defaultUser = {
            name: '早川',
            id: '1h1y2k7w4a',
            password: 'kousuke2007',
            level: 1,
            exp: 0,
            points: 0,
            studyTime: {},
            achievements: [],
            expMultiplier: 1,
            pointMultiplier: 1,
            profileImage: 'https://via.placeholder.com/100',
            createdAt: new Date().toISOString()
        };

        // 初期化
        function init() {
            // デフォルトユーザーを作成
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            if (!users.find(u => u.id === defaultUser.id)) {
                users.push(defaultUser);
                localStorage.setItem('users', JSON.stringify(users));
            }

            // 初期データを設定
            if (!localStorage.getItem('posts')) {
                localStorage.setItem('posts', JSON.stringify([]));
            }
            if (!localStorage.getItem('chats')) {
                localStorage.setItem('chats', JSON.stringify({}));
            }
            if (!localStorage.getItem('groups')) {
                localStorage.setItem('groups', JSON.stringify([]));
            }
            if (!localStorage.getItem('flashcardSets')) {
                localStorage.setItem('flashcardSets', JSON.stringify({}));
            }
            if (!localStorage.getItem('achievements')) {
                initializeAchievements();
            }
            if (!localStorage.getItem('adminUsers')) {
                localStorage.setItem('adminUsers', JSON.stringify({}));
            }
        }

        // パスワードチェック
        function checkPassword() {
            const password = document.getElementById('accessPassword').value;
            if (password === '20studyhome25') {
                document.getElementById('passwordScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
            } else {
                showNotification('パスワードが間違っています', 'error');
            }
        }

        // ログイン
        function login() {
            const name = document.getElementById('loginName').value;
            const id = document.getElementById('loginId').value;

            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => u.name === name && u.id === id);

            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                updateUI();
                setupReminder();
                showNotification('ログインしました');
            } else {
                showNotification('ユーザー名またはIDが間違っています', 'error');
            }
        }

        // 新規登録
        function register() {
            const name = document.getElementById('registerName').value;
            const id = document.getElementById('registerId').value;

            if (!name || !id) {
                showNotification('ユーザー名とIDを入力してください', 'error');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users') || '[]');
            
            if (users.find(u => u.id === id)) {
                showNotification('このIDは既に使用されています', 'error');
                return;
            }

            const newUser = {
                name,
                id,
                level: 1,
                exp: 0,
                points: 0,
                studyTime: {},
                achievements: [],
                expMultiplier: 1,
                pointMultiplier: 1,
                profileImage: 'https://via.placeholder.com/100',
                createdAt: new Date().toISOString()
            };

            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            
            showNotification('アカウントが作成されました');
            document.getElementById('registerName').value = '';
            document.getElementById('registerId').value = '';
        }

        // ログアウト
        function logout() {
            if (timerInterval) clearInterval(timerInterval);
            if (reminderInterval) clearInterval(reminderInterval);
            currentUser = null;
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        // UI更新
        function updateUI() {
            if (!currentUser) return;

            document.getElementById('userInfo').textContent = `${currentUser.name} (Lv.${currentUser.level})`;
            document.getElementById('profileName').textContent = currentUser.name;
            document.getElementById('userLevel').textContent = currentUser.level;
            document.getElementById('userExp').textContent = currentUser.exp;
            document.getElementById('userPoints').textContent = currentUser.points;

            const nextLevelExp = getNextLevelExp(currentUser.level);
            document.getElementById('nextLevelExp').textContent = nextLevelExp;
            const expProgress = (currentUser.exp % nextLevelExp) / nextLevelExp * 100;
            document.getElementById('expBar').style.width = `${expProgress}%`;

            updateProfileFrame();
            updatePosts();
            updateChatUsersList();
            updateAchievements();
            updateFlashcardSets();
            updateShopPrices();
        }

        // 画面切り替え
        function showScreen(screenName) {
            // すべての画面を非表示
            document.querySelectorAll('#mainApp > main > div').forEach(screen => {
                screen.classList.add('hidden');
            });

            // 指定された画面を表示
            document.getElementById(`${screenName}Screen`).classList.remove('hidden');
            currentScreen = screenName;

            // 画面固有の処理
            if (screenName === 'timer') {
                updateStudyChart();
            } else if (screenName === 'chat') {
                updateChatUsersList();
            } else if (screenName === 'flashcard') {
                updateFlashcardSets();
            } else if (screenName === 'profile') {
                updateAchievements();
            }
        }

        // タイマー機能
        function startTimer() {
            if (!isTimerRunning) {
                isTimerRunning = true;
                document.getElementById('startTimer').classList.add('hidden');
                document.getElementById('pauseTimer').classList.remove('hidden');

                timerInterval = setInterval(() => {
                    currentTime--;
                    updateTimerDisplay();

                    if (currentTime <= 0) {
                        completeStudySession();
                    }
                }, 1000);
            }
        }

        function pauseTimer() {
            if (isTimerRunning) {
                isTimerRunning = false;
                clearInterval(timerInterval);
                document.getElementById('startTimer').classList.remove('hidden');
                document.getElementById('pauseTimer').classList.add('hidden');
            }
        }

        function resetTimer() {
            pauseTimer();
            currentTime = parseInt(document.getElementById('pomodoroTime').value) * 60;
            updateTimerDisplay();
        }

        function setPomodoroTimer() {
            const minutes = parseInt(document.getElementById('pomodoroTime').value);
            currentTime = minutes * 60;
            updateTimerDisplay();
        }

        function setCustomTimer() {
            const minutes = parseInt(document.getElementById('customTime').value);
            if (minutes > 0) {
                currentTime = minutes * 60;
                updateTimerDisplay();
                document.getElementById('customTime').value = '';
            }
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(currentTime / 60);
            const seconds = currentTime % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function completeStudySession() {
            pauseTimer();
            const subject = document.getElementById('studySubject').value;
            const sessionTime = parseInt(document.getElementById('pomodoroTime').value);
            
            recordStudyTime(sessionTime, subject);
            
            if (!document.getElementById('quietMode').checked) {
                showNotification(`お疲れ様でした！${sessionTime}分の学習が完了しました`);
            }

            checkAchievements();
        }

        function recordManualTime() {
            const hours = parseInt(document.getElementById('manualHours').value) || 0;
            const minutes = parseInt(document.getElementById('manualMinutes').value) || 0;
            const totalMinutes = hours * 60 + minutes;
            
            if (totalMinutes > 0) {
                const subject = document.getElementById('studySubject').value;
                recordStudyTime(totalMinutes, subject);
                document.getElementById('manualHours').value = '';
                document.getElementById('manualMinutes').value = '';
                showNotification(`${totalMinutes}分の学習時間を記録しました`);
                checkAchievements();
            }
        }

        function recordStudyTime(minutes, subject) {
            const today = new Date().toDateString();
            
            if (!currentUser.studyTime[today]) {
                currentUser.studyTime[today] = {};
            }
            
            if (!currentUser.studyTime[today][subject]) {
                currentUser.studyTime[today][subject] = 0;
            }
            
            currentUser.studyTime[today][subject] += minutes;
            
            // ポイントと経験値を追加
            const points = Math.floor(minutes / 30) * 50 * currentUser.pointMultiplier;
            const exp = minutes * 10 * currentUser.expMultiplier;
            
            currentUser.points += points;
            addExp(exp);
            
            saveUsers();
            updateUI();
        }

        // 経験値とレベルアップ
        function addExp(exp) {
            currentUser.exp += exp;
            
            while (currentUser.exp >= getNextLevelExp(currentUser.level)) {
                levelUp();
            }
        }

        function getNextLevelExp(level) {
            if (level === 1) return 100;
            return Math.floor(130 * Math.pow(1.3, level - 2));
        }

        function levelUp() {
            currentUser.level++;
            const multiplier = 1 + (currentUser.level - 1) * 0.01;
            currentUser.expMultiplier *= 1.01;
            currentUser.pointMultiplier *= 1.01;
            
            showNotification(`レベルアップ！レベル${currentUser.level}になりました！`);
            updateProfileFrame();
        }

        function updateProfileFrame() {
            const profileImg = document.getElementById('profileImage');
            const totalExp = getTotalExp();
            
            profileImg.className = 'w-24 h-24 rounded-full mx-auto mb-4';
            
            if (totalExp >= 30000000) {
                profileImg.classList.add('user-frame-diamond');
            } else if (totalExp >= 5900000) {
                profileImg.classList.add('user-frame-gold');
            } else if (totalExp >= 600000) {
                profileImg.classList.add('user-frame-silver');
            } else if (totalExp >= 18000) {
                profileImg.classList.add('user-frame-red');
            } else if (totalExp >= 6000) {
                profileImg.classList.add('user-frame-green');
            } else {
                profileImg.classList.add('user-frame-blue');
            }
        }

        function getTotalExp() {
            let total = currentUser.exp;
            for (let i = 1; i < currentUser.level; i++) {
                total += getNextLevelExp(i);
            }
            return total;
        }

        // 投稿機能
        function submitPost() {
            const content = document.getElementById('postContent').value;
            const fileInput = document.getElementById('postFile');
            
            if (!content.trim()) {
                showNotification('投稿内容を入力してください', 'error');
                return;
            }

            const post = {
                id: Date.now(),
                userId: currentUser.id,
                userName: currentUser.name,
                content,
                file: null,
                timestamp: new Date().toISOString()
            };

            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    post.file = {
                        name: file.name,
                        type: file.type,
                        data: e.target.result
                    };
                    savePosts(post);
                };
                reader.readAsDataURL(file);
            } else {
                savePosts(post);
            }
        }

        function savePosts(post) {
            const posts = JSON.parse(localStorage.getItem('posts') || '[]');
            posts.unshift(post);
            localStorage.setItem('posts', JSON.stringify(posts));
            
            document.getElementById('postContent').value = '';
            document.getElementById('postFile').value = '';
            
            updatePosts();
            showNotification('投稿しました');
        }

        function updatePosts() {
            const posts = JSON.parse(localStorage.getItem('posts') || '[]');
            const postsList = document.getElementById('postsList');
            
            postsList.innerHTML = posts.map(post => `
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">
                                ${post.userName.charAt(0)}
                            </div>
                            <div>
                                <p class="font-semibold">${post.userName}</p>
                                <p class="text-sm text-gray-500">${new Date(post.timestamp).toLocaleString()}</p>
                            </div>
                        </div>
                        ${post.userId === currentUser.id || isAdmin() ? 
                            `<button onclick="deletePost(${post.id})" class="text-red-500 hover:text-red-700">
                                <i class="fas fa-trash"></i>
                            </button>` : ''
                        }
                    </div>
                    <p class="text-gray-800 mb-3">${post.content}</p>
                    ${post.file ? 
                        post.file.type.startsWith('image/') ?
                            `<img src="${post.file.data}" alt="${post.file.name}" class="max-w-full h-auto rounded-lg">` :
                            `<a href="${post.file.data}" download="${post.file.name}" class="text-blue-500 hover:underline">
                                <i class="fas fa-file"></i> ${post.file.name}
                            </a>`
                        : ''
                    }
                </div>
            `).join('');
        }

        function deletePost(postId) {
            if (confirm('この投稿を削除しますか？')) {
                const posts = JSON.parse(localStorage.getItem('posts') || '[]');
                const filteredPosts = posts.filter(post => post.id !== postId);
                localStorage.setItem('posts', JSON.stringify(filteredPosts));
                updatePosts();
                showNotification('投稿を削除しました');
            }
        }

        // チャット機能
        function updateChatUsersList() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const usersList = document.getElementById('usersList');
            
            usersList.innerHTML = users
                .filter(user => user.id !== currentUser.id)
                .map(user => `
                    <button onclick="selectChatUser('${user.id}')" class="w-full text-left p-2 rounded hover:bg-gray-100 ${currentChatTarget === user.id ? 'bg-blue-100' : ''}">
                        <div class="flex items-center space-x-2">
                            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                                ${user.name.charAt(0)}
                            </div>
                            <span class="text-sm">${user.name}</span>
                        </div>
                    </button>
                `).join('');

            // グループチャット一覧も更新
            const groups = JSON.parse(localStorage.getItem('groups') || '[]');
            const groupsList = document.getElementById('groupsList');
            
            groupsList.innerHTML = groups
                .filter(group => group.members.includes(currentUser.id))
                .map(group => `
                    <button onclick="selectChatGroup('${group.id}')" class="w-full text-left p-2 rounded hover:bg-gray-100 ${currentChatTarget === group.id && currentChatType === 'group' ? 'bg-blue-100' : ''}">
                        <div class="flex items-center space-x-2">
                            <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                                <i class="fas fa-users"></i>
                            </div>
                            <span class="text-sm">${group.name}</span>
                        </div>
                    </button>
                `).join('');
        }

        function selectChatUser(userId) {
            currentChatTarget = userId;
            currentChatType = 'user';
            updateChatArea();
            document.getElementById('chatInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            updateChatUsersList();
        }

        function selectChatGroup(groupId) {
            currentChatTarget = groupId;
            currentChatType = 'group';
            updateChatArea();
            document.getElementById('chatInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            updateChatUsersList();
        }

        function updateChatArea() {
            const chatArea = document.getElementById('chatArea');
            const chats = JSON.parse(localStorage.getItem('chats') || '{}');
            
            let chatKey;
            if (currentChatType === 'group') {
                chatKey = `group_${currentChatTarget}`;
            } else {
                chatKey = [currentUser.id, currentChatTarget].sort().join('_');
            }
            
            const messages = chats[chatKey] || [];
            
            chatArea.innerHTML = messages.map(msg => `
                <div class="chat-message ${msg.senderId === currentUser.id ? 'ml-8' : 'mr-8'}">
                    <div class="flex items-start space-x-2">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold">
                            ${msg.senderName.charAt(0)}
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="font-semibold text-sm">${msg.senderName}</span>
                                <span class="text-xs text-gray-500">${new Date(msg.timestamp).toLocaleTimeString()}</span>
                                ${msg.senderId === currentUser.id ? 
                                    `<button onclick="deleteChatMessage('${chatKey}', ${msg.id})" class="text-red-500 hover:text-red-700 text-xs">
                                        <i class="fas fa-trash"></i>
                                    </button>` : ''
                                }
                            </div>
                            <p class="text-gray-800">${msg.content}</p>
                        </div>
                    </div>
                </div>
            `).join('');
            
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const content = input.value.trim();
            
            if (!content || !currentChatTarget) return;
            
            const message = {
                id: Date.now(),
                senderId: currentUser.id,
                senderName: currentUser.name,
                content,
                timestamp: new Date().toISOString()
            };
            
            const chats = JSON.parse(localStorage.getItem('chats') || '{}');
            
            let chatKey;
            if (currentChatType === 'group') {
                chatKey = `group_${currentChatTarget}`;
            } else {
                chatKey = [currentUser.id, currentChatTarget].sort().join('_');
            }
            
            if (!chats[chatKey]) {
                chats[chatKey] = [];
            }
            
            chats[chatKey].push(message);
            localStorage.setItem('chats', JSON.stringify(chats));
            
            input.value = '';
            updateChatArea();
            
            checkFirstChatAchievement();
        }

        function deleteChatMessage(chatKey, messageId) {
            if (confirm('このメッセージを削除しますか？')) {
                const chats = JSON.parse(localStorage.getItem('chats') || '{}');
                if (chats[chatKey]) {
                    chats[chatKey] = chats[chatKey].filter(msg => msg.id !== messageId);
                    localStorage.setItem('chats', JSON.stringify(chats));
                    updateChatArea();
                }
            }
        }

        function showCreateGroup() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const otherUsers = users.filter(user => user.id !== currentUser.id);
            
            const modalContent = `
                <h3 class="text-lg font-semibold mb-4">グループ作成</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">グループ名</label>
                        <input type="text" id="groupName" placeholder="グループ名を入力" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">メンバーを選択</label>
                        <div id="groupMembers" class="space-y-2 max-h-40 overflow-y-auto">
                            ${otherUsers.map(user => `
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" value="${user.id}" class="group-member-checkbox">
                                    <span>${user.name}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="createGroup()" class="flex-1 bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
                            作成
                        </button>
                        <button onclick="closeModal()" class="flex-1 bg-gray-500 text-white p-2 rounded hover:bg-gray-600">
                            キャンセル
                        </button>
                    </div>
                </div>
            `;
            
            showModal(modalContent);
        }

        function createGroup() {
            const groupName = document.getElementById('groupName').value;
            const checkboxes = document.querySelectorAll('.group-member-checkbox:checked');
            const members = Array.from(checkboxes).map(cb => cb.value);
            members.push(currentUser.id); // 作成者も追加
            
            if (!groupName.trim()) {
                showNotification('グループ名を入力してください', 'error');
                return;
            }
            
            if (members.length < 2) {
                showNotification('最低1人のメンバーを選択してください', 'error');
                return;
            }
            
            const groups = JSON.parse(localStorage.getItem('groups') || '[]');
            const newGroup = {
                id: Date.now().toString(),
                name: groupName,
                members,
                createdBy: currentUser.id,
                createdAt: new Date().toISOString()
            };
            
            groups.push(newGroup);
            localStorage.setItem('groups', JSON.stringify(groups));
            
            closeModal();
            updateChatUsersList();
            showNotification('グループを作成しました');
        }

        // 単語カード機能
        function updateFlashcardSets() {
            const flashcardSets = JSON.parse(localStorage.getItem('flashcardSets') || '{}');
            const userSets = flashcardSets[currentUser.id] || {};
            const setsContainer = document.getElementById('flashcardSets');
            
            setsContainer.innerHTML = Object.entries(userSets).map(([setId, setData]) => `
                <div class="bg-white rounded-lg shadow p-4 mb-4">
                    <div class="flex justify-between items-center">
                        <h3 class="font-semibold">${setData.name}</h3>
                        <div class="space-x-2">
                            <span class="text-sm text-gray-600">${setData.cards.length}枚</span>
                            <button onclick="selectFlashcardSet('${setId}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                学習
                            </button>
                            <button onclick="deleteFlashcardSet('${setId}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                削除
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between mt-2">
                        <div class="flex items-center space-x-2">
                            <label class="text-sm">公開設定:</label>
                            <input type="checkbox" ${setData.isPublic ? 'checked' : ''} onchange="toggleFlashcardSetPublic('${setId}')" class="toggle">
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showCreateFlashcardSet() {
            const modalContent = `
                <h3 class="text-lg font-semibold mb-4">新しい単語カードセット</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">セット名</label>
                        <input type="text" id="flashcardSetName" placeholder="例: 英検3級" class="w-full p-2 border rounded">
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="createFlashcardSet()" class="flex-1 bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
                            作成
                        </button>
                        <button onclick="closeModal()" class="flex-1 bg-gray-500 text-white p-2 rounded hover:bg-gray-600">
                            キャンセル
                        </button>
                    </div>
                </div>
            `;
            showModal(modalContent);
        }

        function createFlashcardSet() {
            const setName = document.getElementById('flashcardSetName').value;
            
            if (!setName.trim()) {
                showNotification('セット名を入力してください', 'error');
                return;
            }
            
            const flashcardSets = JSON.parse(localStorage.getItem('flashcardSets') || '{}');
            if (!flashcardSets[currentUser.id]) {
                flashcardSets[currentUser.id] = {};
            }
            
            const setId = Date.now().toString();
            flashcardSets[currentUser.id][setId] = {
                name: setName,
                cards: [],
                isPublic: false,
                createdAt: new Date().toISOString()
            };
            
            localStorage.setItem('flashcardSets', JSON.stringify(flashcardSets));
            
            closeModal();
            updateFlashcardSets();
            showNotification('単語カードセットを作成しました');
        }

        function selectFlashcardSet(setId) {
            currentFlashcardSet = setId;
            currentFlashcardIndex = 0;
            document.getElementById('addCardBtn').style.display = 'block';
            displayCurrentFlashcard();
        }

        function displayCurrentFlashcard() {
            const flashcardSets = JSON.parse(localStorage.getItem('flashcardSets') || '{}');
            const userSets = flashcardSets[currentUser.id] || {};
            const currentSet = userSets[currentFlashcardSet];
            
            if (!currentSet || currentSet.cards.length === 0) {
                document.getElementById('flashcardDisplay').innerHTML = `
                    <p class="text-gray-500">このセットにはまだカードがありません</p>
                    <button onclick="showAddFlashcard()" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        カードを追加
                    </button>
                `;
                return;
            }
            
            const card = currentSet.cards[currentFlashcardIndex];
            
            document.getElementById('flashcardDisplay').innerHTML = `
                <div class="text-center mb-4">
                    <h3 class="text-lg font-semibold mb-2">${currentSet.name}</h3>
                    <p class="text-sm text-gray-600">${currentFlashcardIndex + 1} / ${currentSet.cards.length}</p>
                </div>
                
                <div class="flashcard" onclick="flipCard(this)">
                    <div class="flashcard-inner">
                        <div class="flashcard-front">
                            <div class="p-4">
                                <p class="text-lg">${card.front}</p>
                            </div>
                        </div>
                        <div class="flashcard-back">
                            <div class="p-4">
                                <p class="text-lg">${card.back}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-center space-x-4 mt-6">
                    <button onclick="prevCard()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" ${currentFlashcardIndex === 0 ? 'disabled' : ''}>
                        前へ
                    </button>
                    <button onclick="nextCard()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" ${currentFlashcardIndex === currentSet.cards.length - 1 ? 'disabled' : ''}>
                        次へ
                    </button>
                </div>
            `;
        }

        function flipCard(cardElement) {
            cardElement.classList.toggle('flipped');
        }

        function prevCard() {
            if (currentFlashcardIndex > 0) {
                currentFlashcardIndex--;
                displayCurrentFlashcard();
            }
        }

        function nextCard() {
            const flashcardSets = JSON.parse(localStorage.getItem('flashcardSets') || '{}');
            const userSets = flashcardSets[currentUser.id] || {};
            const currentSet = userSets[currentFlashcardSet];
            
            if (currentFlashcardIndex < currentSet.cards.length - 1) {
                currentFlashcardIndex++;
                displayCurrentFlashcard();
            }
        }

        function showAddFlashcard() {
            const modalContent = `
                <h3 class="text-lg font-semibold mb-4">カード追加</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">表面（問題）</label>
                        <textarea id="cardFront" placeholder="例: apple" class="w-full p-2 border rounded h-20"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">裏面（答え）</label>
                        <textarea id="cardBack" placeholder="例: りんご" class="w-full p-2 border rounded h-20"></textarea>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="addFlashcard()" class="flex-1 bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
                            追加
                        </button>
                        <button onclick="closeModal()" class="flex-1 bg-gray-500 text-white p-2 rounded hover:bg-gray-600">
                            キャンセル
                        </button>
                    </div>
                </div>
            `;
            showModal(modalContent);
        }

        function addFlashcard() {
            const front = document.getElementById('cardFront').value.trim();
            const back = document.getElementById('cardBack').value.trim();
            
            if (!front || !back) {
                showNotification('表面と裏面を入力してください', 'error');
                return;
            }
            
            const flashcardSets = JSON.parse(localStorage.getItem('flashcardSets') || '{}');
            if (!flashcardSets[currentUser.id][currentFlashcardSet]) {
                return;
            }
            
            flashcardSets[currentUser.id][currentFlashcardSet].cards.push({
                id: Date.now(),
                front,
                back,
                createdAt: new Date().toISOString()
            });
            
            localStorage.setItem('flashcardSets', JSON.stringify(flashcardSets));
            
            closeModal();
            displayCurrentFlashcard();
            updateFlashcardSets();
            showNotification('カードを追加しました');
        }

        function deleteFlashcardSet(setId) {
            if (confirm('この単語カードセットを削除しますか？')) {
                const flashcardSets = JSON.parse(localStorage.getItem('flashcardSets') || '{}');
                delete flashcardSets[currentUser.id][setId];
                localStorage.setItem('flashcardSets', JSON.stringify(flashcardSets));
                
                if (currentFlashcardSet === setId) {
                    currentFlashcardSet = null;
                    document.getElementById('addCardBtn').style.display = 'none';
                    document.getElementById('flashcardDisplay').innerHTML = '<p class="text-gray-500">単語カードセットを選択してください</p>';
                }
                
                updateFlashcardSets();
                showNotification('単語カードセットを削除しました');
            }
        }

        function toggleFlashcardSetPublic(setId) {
            const flashcardSets = JSON.parse(localStorage.getItem('flashcardSets') || '{}');
            if (flashcardSets[currentUser.id][setId]) {
                flashcardSets[currentUser.id][setId].isPublic = !flashcardSets[currentUser.id][setId].isPublic;
                localStorage.setItem('flashcardSets', JSON.stringify(flashcardSets));
            }
        }

        // アチーブメント機能
        function initializeAchievements() {
            const achievements = {
                'first_step': {
                    name: 'はじめの一歩',
                    description: '初回ログイン',
                    condition: 'login_once',
                    image: '🦶',
                    rarity: 'common'
                },
                'not_3days': {
                    name: '3日坊主じゃない!',
                    description: '3日連続でログイン',
                    condition: 'login_streak_3',
                    image: '🌱',
                    rarity: 'common'
                },
                'focus_30': {
                    name: '集中の30分',
                    description: '30分間の学習を完了',
                    condition: 'study_30min',
                    image: '🕐',
                    rarity: 'common'
                },
                'first_chat': {
                    name: '初チャット!',
                    description: '初回チャット送信',
                    condition: 'chat_once',
                    image: '💬',
                    rarity: 'common'
                },
                'room_debut': {
                    name: 'ルームデビュー',
                    description: '初回グループチャット参加',
                    condition: 'join_group_once',
                    image: '🚪',
                    rarity: 'common'
                },
                'timer_crafter_1': {
                    name: 'タイマー職人Lv.1',
                    description: 'タイマーを3回使用',
                    condition: 'timer_use_3',
                    image: '⏲️',
                    rarity: 'common'
                },
                'week_trace': {
                    name: '1週間の軌跡',
                    description: '7日連続でログイン',
                    condition: 'login_streak_7',
                    image: '📅',
                    rarity: 'normal'
                },
                'pomodoro_master_1': {
                    name: 'ポモドーロマスターLv.1',
                    description: 'ポモドーロタイマーを10回完了',
                    condition: 'pomodoro_complete_10',
                    image: '🍅',
                    rarity: 'normal'
                },
                'morning_people': {
                    name: '朝活の民',
                    description: '朝6時〜9時に5回学習',
                    condition: 'morning_study_5',
                    image: '🌅',
                    rarity: 'normal'
                },
                'night_warrior': {
                    name: '夜ふかし戦士',
                    description: '夜22時〜2時に5回学習',
                    condition: 'night_study_5',
                    image: '🌙',
                    rarity: 'normal'
                },
                '10hour_break': {
                    name: '10時間突破!',
                    description: '累計学習時間10時間達成',
                    condition: 'total_study_10h',
                    image: '🎯',
                    rarity: 'normal'
                },
                'schedule_master_1': {
                    name: 'スケジュールマスターLv.1',
                    description: '5日間毎日学習記録',
                    condition: 'daily_study_5',
                    image: '📋',
                    rarity: 'normal'
                },
                'teaching_hard': {
                    name: '教えるってむずい!',
                    description: '初回投稿',
                    condition: 'post_once',
                    image: '📚',
                    rarity: 'normal'
                },
                'found_friends': {
                    name: '気づけば仲間と',
                    description: '3人以上とチャット',
                    condition: 'chat_with_3_users',
                    image: '👥',
                    rarity: 'normal'
                },
                'weekly_challenger': {
                    name: '週間チャレンジャー',
                    description: '1週間で20時間学習',
                    condition: 'week_study_20h',
                    image: '🏔️',
                    rarity: 'normal'
                },
                'title_holder': {
                    name: '称号を得し者',
                    description: '5個のアチーブメント獲得',
                    condition: 'achievements_5',
                    image: '🏆',
                    rarity: 'normal'
                },
                'pomodoro_king': {
                    name: 'ポモドーロキング',
                    description: 'ポモドーロタイマーを100回完了',
                    condition: 'pomodoro_complete_100',
                    image: '👑',
                    rarity: 'rare'
                },
                'persistence_power': {
                    name: '継続は力なり',
                    description: '30日連続でログイン',
                    condition: 'login_streak_30',
                    image: '🏛️',
                    rarity: 'rare'
                },
                '100hour_break': {
                    name: '学習時間100時間突破!',
                    description: '累計学習時間100時間達成',
                    condition: 'total_study_100h',
                    image: '🔥',
                    rarity: 'rare'
                },
                'perfect_achiever': {
                    name: '完全達成者',
                    description: '隠しアチーブメント',
                    condition: 'hidden_special',
                    image: '💎',
                    rarity: 'legendary',
                    hidden: true
                }
            };
            
            localStorage.setItem('achievements', JSON.stringify(achievements));
        }

        function updateAchievements() {
            const achievements = JSON.parse(localStorage.getItem('achievements') || '{}');
            const achievementsList = document.getElementById('achievementsList');
            
            achievementsList.innerHTML = Object.entries(achievements)
                .filter(([id, achievement]) => !achievement.hidden || currentUser.achievements.includes(id))
                .map(([id, achievement]) => {
                    const unlocked = currentUser.achievements.includes(id);
                    const rarityColor = {
                        common: 'bg-blue-200',
                        normal: 'bg-green-200',
                        rare: 'bg-purple-200',
                        legendary: 'bg-yellow-200'
                    }[achievement.rarity];
                    
                    return `
                        <div class="text-center">
                            <div class="achievement-badge ${rarityColor} ${unlocked ? '' : 'opacity-50'}">
                                ${achievement.image}
                            </div>
                            <p class="text-xs font-semibold mt-1">${achievement.name}</p>
                            <p class="text-xs text-gray-600">${achievement.description}</p>
                        </div>
                    `;
                }).join('');
        }

        function checkAchievements() {
            const achievements = JSON.parse(localStorage.getItem('achievements') || '{}');
            let newAchievements = [];
            
            // 各アチーブメントの条件をチェック
            Object.entries(achievements).forEach(([id, achievement]) => {
                if (!currentUser.achievements.includes(id)) {
                    if (checkAchievementCondition(achievement.condition)) {
                        currentUser.achievements.push(id);
                        newAchievements.push(achievement.name);
                        
                        // 完全達成者の特別効果
                        if (id === 'perfect_achiever') {
                            currentUser.expMultiplier *= 1.5;
                            currentUser.pointMultiplier *= 1.5;
                        }
                    }
                }
            });
            
            if (newAchievements.length > 0) {
                saveUsers();
                updateAchievements();
                showNotification(`アチーブメント獲得: ${newAchievements.join(', ')}`);
            }
        }

        function checkAchievementCondition(condition) {
            // アチーブメント条件の判定ロジック（簡略化版）
            switch (condition) {
                case 'login_once':
                    return true; // ログイン時点で達成
                case 'study_30min':
                    return getTotalStudyTime() >= 30;
                case 'chat_once':
                    return hasChattedOnce();
                case 'post_once':
                    return hasPostedOnce();
                case 'total_study_10h':
                    return getTotalStudyTime() >= 600; // 10時間 = 600分
                case 'total_study_100h':
                    return getTotalStudyTime() >= 6000; // 100時間 = 6000分
                case 'achievements_5':
                    return currentUser.achievements.length >= 5;
                case 'hidden_special':
                    return checkSpecialCondition();
                default:
                    return false;
            }
        }

        function getTotalStudyTime() {
            let total = 0;
            Object.values(currentUser.studyTime).forEach(dayData => {
                Object.values(dayData).forEach(time => {
                    total += time;
                });
            });
            return total;
        }

        function hasChattedOnce() {
            const chats = JSON.parse(localStorage.getItem('chats') || '{}');
            return Object.values(chats).some(chat => 
                chat.some(msg => msg.senderId === currentUser.id)
            );
        }

        function hasPostedOnce() {
            const posts = JSON.parse(localStorage.getItem('posts') || '[]');
            return posts.some(post => post.userId === currentUser.id);
        }

        function checkSpecialCondition() {
            // 3週間の間に4時間以上勉強した日が19日以上ある
            const now = new Date();
            const threeWeeksAgo = new Date(now.getTime() - 21 * 24 * 60 * 60 * 1000);
            
            let validDays = 0;
            Object.entries(currentUser.studyTime).forEach(([dateStr, dayData]) => {
                const date = new Date(dateStr);
                if (date >= threeWeeksAgo && date <= now) {
                    const totalMinutes = Object.values(dayData).reduce((sum, time) => sum + time, 0);
                    if (totalMinutes >= 240) { // 4時間 = 240分
                        validDays++;
                    }
                }
            });
            
            return validDays >= 19;
        }

        function checkFirstChatAchievement() {
            if (!currentUser.achievements.includes('first_chat')) {
                currentUser.achievements.push('first_chat');
                saveUsers();
                updateAchievements();
                showNotification('アチーブメント獲得: 初チャット!');
            }
        }

        // ショップ機能
        function updateShopPrices() {
            const expBoosterCount = currentUser.expBoosterCount || 0;
            const allBoosterCount = currentUser.allBoosterCount || 0;
            
            const expPrice = Math.floor(100 * Math.pow(1.3, expBoosterCount));
            const allPrice = Math.floor(200 * Math.pow(1.3, allBoosterCount));
            
            document.getElementById('expBoosterPrice').textContent = expPrice;
            document.getElementById('allBoosterPrice').textContent = allPrice;
        }

        function buyExpBooster() {
            const expBoosterCount = currentUser.expBoosterCount || 0;
            const price = Math.floor(100 * Math.pow(1.3, expBoosterCount));
            
            if (currentUser.points >= price) {
                currentUser.points -= price;
                currentUser.expMultiplier *= 1.1;
                currentUser.expBoosterCount = (currentUser.expBoosterCount || 0) + 1;
                
                saveUsers();
                updateUI();
                updateShopPrices();
                showNotification('経験値ブースターを購入しました');
            } else {
                showNotification('ポイントが不足しています', 'error');
            }
        }

        function buyAllBooster() {
            const allBoosterCount = currentUser.allBoosterCount || 0;
            const price = Math.floor(200 * Math.pow(1.3, allBoosterCount));
            
            if (currentUser.points >= price) {
                currentUser.points -= price;
                currentUser.expMultiplier *= 1.2;
                currentUser.pointMultiplier *= 1.2;
                currentUser.allBoosterCount = (currentUser.allBoosterCount || 0) + 1;
                
                saveUsers();
                updateUI();
                updateShopPrices();
                showNotification('全能ブースターを購入しました');
            } else {
                showNotification('ポイントが不足しています', 'error');
            }
        }

        // 設定機能
        function changeBackgroundColor() {
            const color = document.getElementById('backgroundColor').value;
            document.body.style.backgroundColor = color;
            localStorage.setItem(`bgColor_${currentUser.id}`, color);
        }

        function changeBackgroundImage() {
            const input = document.getElementById('backgroundImage');
            const file = input.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.body.style.backgroundImage = `url(${e.target.result})`;
                    document.body.style.backgroundSize = 'cover';
                    localStorage.setItem(`bgImage_${currentUser.id}`, e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }

        // プロフィール機能
        function updateUsername() {
            const newName = document.getElementById('newUsername').value.trim();
            
            if (!newName) {
                showNotification('新しいユーザー名を入力してください', 'error');
                return;
            }
            
            currentUser.name = newName;
            saveUsers();
            updateUI();
            document.getElementById('newUsername').value = '';
            showNotification('ユーザー名を更新しました');
        }

        function updateProfileImage() {
            const input = document.getElementById('profileImageInput');
            const file = input.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentUser.profileImage = e.target.result;
                    document.getElementById('profileImage').src = e.target.result;
                    saveUsers();
                    showNotification('プロフィール画像を更新しました');
                };
                reader.readAsDataURL(file);
            }
        }

        // 管理機能
        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            const adminUsers = JSON.parse(localStorage.getItem('adminUsers') || '{}');
            
            if (adminUsers[currentUser.id] && adminUsers[currentUser.id] === password) {
                showScreen('admin');
                updateAdminUI();
                showNotification('管理画面にアクセスしました');
            } else {
                showNotification('管理者パスワードが間違っています', 'error');
            }
        }

        function isAdmin() {
            const adminUsers = JSON.parse(localStorage.getItem('adminUsers') || '{}');
            return adminUsers.hasOwnProperty(currentUser.id);
        }

        function updateAdminUI() {
            // ユーザー一覧を更新
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const adminUsersList = document.getElementById('adminUsersList');
            
            adminUsersList.innerHTML = users.map(user => `
                <div class="flex justify-between items-center p-4 border rounded">
                    <div>
                        <p class="font-semibold">${user.name}</p>
                        <p class="text-sm text-gray-600">ID: ${user.id}</p>
                        <p class="text-sm text-gray-600">レベル: ${user.level}</p>
                    </div>
                    <div class="space-x-2">
                        <button onclick="banUser('${user.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                            アクセス禁止
                        </button>
                        <button onclick="makeAdmin('${user.id}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                            管理者に
                        </button>
                    </div>
                </div>
            `).join('');
            
            // 投稿一覧を更新
            const posts = JSON.parse(localStorage.getItem('posts') || '[]');
            const adminPostsList = document.getElementById('adminPostsList');
            
            adminPostsList.innerHTML = posts.map(post => `
                <div class="flex justify-between items-center p-2 border rounded text-sm">
                    <div class="flex-1">
                        <p class="font-medium">${post.userName}: ${post.content.substring(0, 50)}...</p>
                        <p class="text-gray-500">${new Date(post.timestamp).toLocaleString()}</p>
                    </div>
                    <button onclick="deletePost(${post.id})" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function banUser(userId) {
            if (confirm('このユーザーをアクセス禁止にしますか？')) {
                // 実装省略（実際のアプリケーションでは適切な処理を行う）
                showNotification('ユーザーをアクセス禁止にしました');
            }
        }

        function makeAdmin(userId) {
            const password = prompt('新しい管理者パスワードを設定してください:');
            if (password) {
                const adminUsers = JSON.parse(localStorage.getItem('adminUsers') || '{}');
                adminUsers[userId] = password;
                localStorage.setItem('adminUsers', JSON.stringify(adminUsers));
                showNotification('管理者権限を追加しました');
            }
        }

        function toggleGlobalChat() {
            const enabled = document.getElementById('globalChatEnabled').checked;
            localStorage.setItem('globalChatEnabled', enabled.toString());
            showNotification(enabled ? '全体チャットを開放しました' : '全体チャットを閉鎖しました');
        }

        function showCreateAchievement() {
            const modalContent = `
                <h3 class="text-lg font-semibold mb-4">新しいアチーブメント</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">名前</label>
                        <input type="text" id="achievementName" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">説明</label>
                        <textarea id="achievementDesc" class="w-full p-2 border rounded h-20"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">条件タイプ</label>
                        <select id="achievementCondition" class="w-full p-2 border rounded">
                            <option value="login_streak">連続ログイン</option>
                            <option value="study_time">学習時間</option>
                            <option value="timer_use">タイマー使用回数</option>
                            <option value="chat_count">チャット回数</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">条件値</label>
                        <input type="number" id="achievementValue" class="w-full p-2 border rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">画像（絵文字）</label>
                        <input type="text" id="achievementImage" class="w-full p-2 border rounded">
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="createAchievement()" class="flex-1 bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
                            作成
                        </button>
                        <button onclick="closeModal()" class="flex-1 bg-gray-500 text-white p-2 rounded hover:bg-gray-600">
                            キャンセル
                        </button>
                    </div>
                </div>
            `;
            showModal(modalContent);
        }

        function createAchievement() {
            const name = document.getElementById('achievementName').value;
            const desc = document.getElementById('achievementDesc').value;
            const conditionType = document.getElementById('achievementCondition').value;
            const value = document.getElementById('achievementValue').value;
            const image = document.getElementById('achievementImage').value;
            
            if (!name || !desc || !value || !image) {
                showNotification('すべてのフィールドを入力してください', 'error');
                return;
            }
            
            const achievements = JSON.parse(localStorage.getItem('achievements') || '{}');
            const id = `custom_${Date.now()}`;
            
            achievements[id] = {
                name,
                description: desc,
                condition: `${conditionType}_${value}`,
                image,
                rarity: 'normal'
            };
            
            localStorage.setItem('achievements', JSON.stringify(achievements));
            closeModal();
            showNotification('新しいアチーブメントを作成しました');
        }

        function showSuperAdmin() {
            if (currentUser.name === '早川' && currentUser.id === '1h1y2k7w4a') {
                showNotification('超管理者モードにアクセスしました');
                // 超管理者機能の実装は省略
            } else {
                showNotification('アクセス権限がありません', 'error');
            }
        }

        // 統計・グラフ機能
        function updateStudyChart() {
            const canvas = document.getElementById('studyChart');
            const ctx = canvas.getContext('2d');
            
            if (studyChart) {
                studyChart.destroy();
            }
            
            const period = document.getElementById('chartPeriod').value;
            const data = getStudyData(period);
            
            studyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: '学習時間（分）',
                        data: data.values,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function getStudyData(period) {
            const data = { labels: [], values: [] };
            const studyTime = currentUser.studyTime;
            
            if (period === 'week') {
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toDateString();
                    
                    data.labels.push(date.toLocaleDateString());
                    
                    const dayTotal = studyTime[dateStr] ? 
                        Object.values(studyTime[dateStr]).reduce((sum, time) => sum + time, 0) : 0;
                    data.values.push(dayTotal);
                }
            } else if (period === 'month') {
                for (let i = 29; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toDateString();
                    
                    if (i % 3 === 0) { // 3日おきにラベル表示
                        data.labels.push(date.toLocaleDateString());
                    } else {
                        data.labels.push('');
                    }
                    
                    const dayTotal = studyTime[dateStr] ? 
                        Object.values(studyTime[dateStr]).reduce((sum, time) => sum + time, 0) : 0;
                    data.values.push(dayTotal);
                }
            }
            
            return data;
        }

        // 通知・リマインダー機能
        function setupReminder() {
            if (reminderInterval) clearInterval(reminderInterval);
            
            if (document.getElementById('reminderNotification')?.checked) {
                reminderInterval = setInterval(() => {
                    if (!document.getElementById('quietMode')?.checked) {
                        showNotification('30分が経過しました。休憩しませんか？', 'info');
                    }
                }, 30 * 60 * 1000); // 30分
            }
        }

        // ユーティリティ関数
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type === 'error' ? 'bg-red-500' : type === 'info' ? 'bg-blue-500' : 'bg-green-500'} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showModal(content) {
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
        }

        function saveUsers() {
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
                localStorage.setItem('users', JSON.stringify(users));
            }
        }

        // イベントリスナー
        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            // エンターキーでメッセージ送信
            document.getElementById('chatInput')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // モーダルの外側クリックで閉じる
            document.getElementById('modalOverlay')?.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
            
            // 設定の変更を監視
            document.getElementById('reminderNotification')?.addEventListener('change', setupReminder);
        });
    </script>
</body>
</html>
